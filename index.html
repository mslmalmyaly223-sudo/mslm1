<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>سوق الطلاب</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0000ff">

  <style>
    :root{
      --primary-color:#4a6bff;--secondary-color:#f8f9fa;--accent-color:#ff6b6b;
      --text-color:#222;--light-text:#6c757d;--border-color:#dee2e6;
      --success-color:#28a745;--warning-color:#ffc107;--danger-color:#dc3545;
      --sky:#e9f0ff;
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    [data-theme="dark"] {
      --primary-color: #6c8eff;
      --secondary-color: #1a1a1a;
      --accent-color: #ff6b6b;
      --text-color: #ffffff;
      --light-text: #a0a0a0;
      --border-color: #333333;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --sky: #2a2a2a;
      --gradient-primary: linear-gradient(135deg, #4a6bff 0%, #6a11cb 100%);
      --gradient-secondary: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    html,body{height:100%}
    body{background:#f5f5f5;color:var(--text-color);overscroll-behavior-y:contain;-webkit-text-size-adjust:100%;touch-action:manipulation}
    .container{max-width:100%;min-height:100vh;background:#fff;padding-bottom:70px}

    [data-theme="dark"] body,
    [data-theme="dark"] .container {
      background: #121212;
      color: #ffffff;
    }

    [data-theme="dark"] .post,
    [data-theme="dark"] .company,
    [data-theme="dark"] .modal-content,
    [data-theme="dark"] .header,
    [data-theme="dark"] .bottom-nav {
      background: #1e1e1e;
      color: #ffffff;
      border-color: #333;
    }

    [data-theme="dark"] .form-control,
    [data-theme="dark"] .select-control,
    [data-theme="dark"] .filter-select {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }

    [data-theme="dark"] .post-description {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .profile-actions-card {
      background: var(--gradient-secondary);
    }

    [data-theme="dark"] .post-username,
    [data-theme="dark"] .user-name,
    [data-theme="dark"] .post-title {
      color: #ffffff !important;
    }

    [data-theme="dark"] .filter-container {
      background: #1e1e1e;
      border-color: #333;
    }

    [data-theme="dark"] .filter-select {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }

    .splash {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(60% 90% at 20% 10%, rgba(16,209,255,.20), transparent 60%),
                  radial-gradient(70% 80% at 90% 90%, rgba(106,17,203,.18), transparent 60%),
                  linear-gradient(135deg,#0d0f1a 0%, #0f1330 100%);
      z-index: 9999;
      overflow: hidden;
      transition: opacity .6s ease;
    }

    .splash.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .runner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .08em;
      filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
      pointer-events: none;
    }

    .runner span {
      font-weight: 900;
      font-size: clamp(40px, 9vw, 74px);
      color: #e6ebff;
      display: inline-block;
      opacity: 0;
      transform: translateX(6vw) scale(.96);
      animation: runCentered .8s cubic-bezier(.2,.8,.2,1) forwards;
      will-change: transform, opacity;
    }

    .runner span:nth-child(1){ animation-delay:.00s }
    .runner span:nth-child(2){ animation-delay:.05s }
    .runner span:nth-child(3){ animation-delay:.10s }
    .runner span:nth-child(4){ animation-delay:.15s }
    .runner span:nth-child(5){ animation-delay:.20s }
    .runner span:nth-child(6){ animation-delay:.25s }
    .runner span:nth-child(7){ animation-delay:.30s }
    .runner span:nth-child(8){ animation-delay:.35s }
    .runner span:nth-child(9){ animation-delay:.40s }
    .runner span:nth-child(10){ animation-delay:.45s }

    @keyframes runCentered {
      0% { opacity: 0; transform: translateX(6vw) scale(.96) }
      18% { opacity: 1 }
      55% { transform: translateX(-6vw) scale(1.02) }
      100% { opacity: 0; transform: translateX(-6vw) scale(.98) }
    }

    .final-logo {
      position: relative;
      z-index: 2;
      opacity: 0;
      font-weight: 900;
      font-size: clamp(42px, 9.5vw, 72px);
      color: #eef2ff;
      text-shadow: 0 14px 40px rgba(16,209,255,.22), 0 4px 10px rgba(0,0,0,.5);
      white-space: nowrap;
      line-height: 1;
      direction: rtl;
      unicode-bidi: plaintext;
      animation: logoMerge .55s cubic-bezier(.2,.9,.1,1) var(--merge-delay,1.35s) forwards;
    }

    @keyframes logoMerge {
      0% { opacity: 0; transform: translateY(18px) scale(.94) }
      100% { opacity: 1; transform: translateY(0) scale(1) }
    }

    .loading-text {
      position: absolute;
      bottom: 30%;
      color: #a0b4ff;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      opacity: 0;
      animation: loadingPulse 2s infinite;
      direction: rtl;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    .loading-text.show {
      display: block;
      animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .help-floating-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #4a6bff, #6a11cb);
      color: white;
      padding: 12px 16px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(74, 107, 255, 0.4);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .help-floating-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 107, 255, 0.6);
    }

    .theme-toggle-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      color: white;
      z-index: 1001;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .theme-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .auth-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;background:linear-gradient(135deg,#4a6bff,#6a11cb); position: relative;}
    .auth-box{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;width:100%;max-width:420px;text-align:center}
    .auth-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .auth-tab{flex:1;padding:10px;cursor:pointer;font-weight:500;color:var(--light-text);transition:.3s}
    .auth-tab.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
    .auth-form{display:none}.auth-form.active{display:block}
    .form-group{margin-bottom:15px;text-align:right}
    .form-group label{display:block;margin-bottom:5px;font-weight:500}
    .form-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;transition:.3s}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,107,255,.2)}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}

    .avatar-upload-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin: 15px 0;
    }

    .avatar-upload-btn-large {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 2px dashed var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--light-text);
    }

    .avatar-upload-btn-large:hover {
        border-color: var(--primary-color);
        background: var(--sky);
        color: var(--primary-color);
        transform: translateY(-2px);
    }

    .avatar-upload-btn-large i {
        font-size: 24px;
        margin-bottom: 8px;
    }

    .avatar-upload-btn-large span {
        font-size: 12px;
        font-weight: 600;
    }

    .avatar-container {
        position: relative;
        display: inline-block;
    }

    .avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: #d7e4ff;
        color: #2740b9;
        font-size: 40px;
        cursor: pointer;
        border: 2px solid #c9d7ff;
        overflow: hidden;
    }

    .avatar-upload-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #4a6bff;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .avatar-upload-btn:hover {
        background: #3a5bef;
        transform: scale(1.1);
    }

    .rank-avatar-container {
        position: relative;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
    }

    .rank-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e9ecef;
        background: #f8f9fa;
    }

    .btn{display:inline-block;padding:10px 14px;background:var(--primary-color);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;width:auto}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.65;cursor:not-allowed;transform:none}
    .btn-block{width:100%}
    .btn-secondary{background:var(--secondary-color);color:var(--text-color)}
    .btn-danger{background:var(--danger-color);color:#fff}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color);color:#111}
    .btn-xs{padding:6px 8px;font-size:12px;border-radius:8px}

    .header{position:sticky;top:0;background:#fff;padding:12px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);z-index:100}
    .brand{display:flex;align-items:center;gap:8px}
    .section-switch{display:inline-flex;background:#f2f4ff;border:1px solid #dfe4ff;border-radius:999px;overflow:hidden;margin-inline-start:10px}
    .section-pill{padding:6px 10px;font-size:12px;font-weight:800;color:#3a5bef;cursor:pointer;border:none;background:transparent}
    .section-pill.active{background:#3a5bef;color:#fff}
    .icon-btn{position:relative;background:transparent;border:none;cursor:pointer;font-size:20px}
    .icon-btn .dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#ff3b3b;border-radius:50%;display:none}
    .icon-btn.has-unseen .dot{display:block}

    .filter-container{padding:15px;background:#fff;border-bottom:1px solid var(--border-color); display:flex; gap:10px;}
    .filter-select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:5px}
    
    .posts-container{padding:15px 15px 90px}
    .pull-indicator{position:relative;height:0;overflow:visible}
    .pull-indicator .bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:#e9f0ff;border:1px solid #d0dcff;border-radius:999px;padding:4px 10px;font-size:12px;color:#3a5bef;display:none}

    .post {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,.05);
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .post.pinned{box-shadow:0 4px 14px rgba(74,107,255,.25)}
    .post .pin-ribbon{position:absolute;top:-8px;right:-8px;background:#4a6bff;color:#fff;font-weight:800;padding:4px 8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:11px}
    .post.sold{opacity:.85;position:relative}
    .post.deleted{opacity:.5;position:relative}
    .post.sold::after{content:"تم بيعه";position:absolute;top:10px;left:10px;background:var(--success-color);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .post-header{display:flex;align-items:flex-start;margin-bottom:0;gap:12px}
    .post-username{display:flex;align-items:center;gap:10px;font-weight:900;color:#111;font-size:17px}
    
    .badge-verified {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 25px;
      background: linear-gradient(135deg, 
        #ff6b6b 0%, 
        #ff8e6b 25%, 
        #ffd166 50%, 
        #06d6a0 75%, 
        #118ab2 100%);
      background-size: 300% 300%;
      color: #ffffff;
      font-size: 12px;
      font-weight: 900;
      border: 2px solid rgba(255, 255, 255, 0.8);
      box-shadow: 
        0 4px 20px rgba(255, 107, 107, 0.4),
        0 6px 30px rgba(255, 214, 102, 0.3),
        0 8px 40px rgba(6, 214, 160, 0.2),
        inset 0 0 30px rgba(255, 255, 255, 0.3),
        0 0 20px rgba(255, 107, 107, 0.5);
      position: relative;
      overflow: hidden;
      animation: 
        gradient-shift 3s ease infinite,
        glow-pulse 2s ease-in-out infinite,
        float-gentle 4s ease-in-out infinite;
      transform-style: preserve-3d;
      perspective: 500px;
      text-shadow: 
        0 1px 2px rgba(0,0,0,0.3),
        0 0 10px rgba(255,255,255,0.5);
      backdrop-filter: blur(10px);
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    .badge-verified::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg, 
        transparent, 
        rgba(255,255,255,0.6), 
        transparent, 
        rgba(255,255,255,0.4),
        transparent
      );
      transform: rotate(45deg);
      animation: shine-sweep 2.5s ease-in-out infinite;
    }

    .badge-verified::after {
      content: '';
      position: absolute;
      inset: 2px;
      background: radial-gradient(
        circle at 30% 20%, 
        rgba(255,255,255,0.5) 0%, 
        transparent 60%
      );
      border-radius: 22px;
      animation: inner-glow 3s ease-in-out infinite;
      filter: blur(5px);
    }

    .badge-verified i {
      font-size: 13px;
      filter: 
        drop-shadow(0 1px 2px rgba(0,0,0,0.3))
        drop-shadow(0 0 8px rgba(255,255,255,0.8));
      animation: 
        icon-bounce 2s ease-in-out infinite,
        icon-spin 8s linear infinite;
      position: relative;
      z-index: 2;
    }

    @keyframes gradient-shift {
      0%, 100% { 
        background-position: 0% 50%;
        box-shadow: 
          0 4px 20px rgba(255, 107, 107, 0.4),
          0 6px 30px rgba(255, 214, 102, 0.3),
          0 8px 40px rgba(6, 214, 160, 0.2);
      }
      25% { 
        background-position: 50% 100%;
        box-shadow: 
          0 4px 20px rgba(255, 214, 102, 0.4),
          0 6px 30px rgba(6, 214, 160, 0.3),
          0 8px 40px rgba(17, 138, 178, 0.2);
      }
      50% { 
        background-position: 100% 50%;
        box-shadow: 
          0 4px 20px rgba(6, 214, 160, 0.4),
          0 6px 30px rgba(17, 138, 178, 0.3),
          0 8px 40px rgba(255, 107, 107, 0.2);
      }
      75% { 
        background-position: 50% 0%;
        box-shadow: 
          0 4px 20px rgba(17, 138, 178, 0.4),
          0 6px 30px rgba(255, 107, 107, 0.3),
          0 8px 40px rgba(255, 214, 102, 0.2);
      }
    }

    @keyframes glow-pulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg);
        box-shadow: 
          0 4px 20px rgba(255, 107, 107, 0.4),
          0 6px 30px rgba(255, 214, 102, 0.3),
          0 8px 40px rgba(6, 214, 160, 0.2);
      }
      50% { 
        transform: scale(1.05) rotate(0.5deg);
        box-shadow: 
          0 6px 30px rgba(255, 107, 107, 0.6),
          0 8px 40px rgba(255, 214, 102, 0.5),
          0 12px 60px rgba(6, 214, 160, 0.4),
          0 0 30px rgba(255, 255, 255, 0.3);
      }
    }

    @keyframes float-gentle {
      0%, 100% { 
        transform: translateY(0px) rotateX(0deg) rotateY(0deg); 
      }
      33% { 
        transform: translateY(-3px) rotateX(1deg) rotateY(1deg); 
      }
      66% { 
        transform: translateY(2px) rotateX(-1deg) rotateY(-1deg); 
      }
    }

    @keyframes shine-sweep {
      0% { transform: rotate(45deg) translateX(-100%) translateY(-100%); }
      100% { transform: rotate(45deg) translateX(200%) translateY(200%); }
    }

    @keyframes inner-glow {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }

    @keyframes icon-bounce {
      0%, 100% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-2px) scale(1.1); }
    }

    @keyframes icon-spin {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.05); }
      50% { transform: rotate(180deg) scale(1.1); }
      75% { transform: rotate(270deg) scale(1.05); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .badge-verified:hover {
      animation: 
        gradient-shift 1s ease infinite,
        glow-pulse 0.5s ease-in-out infinite,
        float-gentle 2s ease-in-out infinite;
      transform: scale(1.1) rotate(2deg);
      box-shadow: 
        0 8px 40px rgba(255, 107, 107, 0.8),
        0 12px 60px rgba(255, 214, 102, 0.6),
        0 16px 80px rgba(6, 214, 160, 0.5),
        0 0 40px rgba(255, 255, 255, 0.5) !important;
    }

    @media (max-width: 768px) {
      .badge-verified {
        padding: 6px 12px;
        font-size: 11px;
        gap: 4px;
      }
      
      .badge-verified i {
        font-size: 12px;
      }
    }

    .post-title{font-weight:800;font-size:15px;color:var(--primary-color)}
    .post-price{justify-self:end;font-weight:900;color:#28a745}
    
    .post-description{
        margin: 0;
        line-height: 1.8;
        color: #222;
        white-space: pre-wrap;
        font-weight: 500;
        text-align: right;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        border-right: 4px solid var(--primary-color);
        word-wrap: break-word;
        overflow-wrap: break-word;
        min-height: auto;
        display: block;
        width: 100%;
        box-sizing: border-box;
        font-size: 15px;
        letter-spacing: 0.3px;
    }
    
    .post-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .owner-tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:8px}

    .company{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:12px;border:1px solid var(--border-color)}
    .company .name{font-weight:900;color:#111;font-size:16px}
    .company .phone{color:#0c7a43;font-weight:800;margin-top:6px}
    .company .route{color:#555;margin-top:6px;font-size:13px}
    .company .desc{color:#333;margin-top:6px}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;overflow-y:auto}
    .modal-content{background:#fff;margin:20px auto;padding:20px;border-radius:12px;width:90%;max-width:520px;animation:modalOpen .25s}
    @keyframes modalOpen{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
    .modal-header h2{font-size:18px;margin:0}
    .close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-text)}
    .select-group{margin-bottom:15px}
    .select-group label{display:block;margin-bottom:5px;font-weight:500}
    .select-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;background:#fff}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

    .profile-shell{padding:16px}
    .profile-card{
        background: var(--gradient-primary);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .profile-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
    }

    .profile-card:hover::before {
        transform: translateX(100%);
    }

    .profile-meta{display:flex;flex-direction:column;gap:6px;flex:1}
    .profile-name-row{display:flex;align-items:center;gap:10px;font-weight:900;font-size:20px;color:#fff}
    .profile-count{font-size:14px;color:rgba(255,255,255,0.9);font-weight:700}
    .profile-email{font-size:13px;color:rgba(255,255,255,0.8);word-break:break-all}
    .profile-uid-input {font-size:12px;padding:6px 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius:6px;}
    .profile-uid-input::placeholder {color: rgba(255,255,255,0.7);}

    .profile-actions-card{
        margin-top: 20px;
        background: var(--gradient-secondary);
        border-radius: 18px;
        padding: 15px;
        box-shadow: 0 6px 20px rgba(138, 43, 226, 0.3);
    }

    .profile-menu{padding:5px}
    .menu-item{
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        margin-bottom: 12px;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .menu-item:hover{
        background: rgba(255,255,255,0.25);
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .menu-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
    }

    .muted{color:#777;font-size:13px}

    #broadcast-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:210}
    #broadcast-overlay.show{display:block}
    #broadcast-banner{
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.98);
      width:min(92%, 380px); max-height:70vh; overflow:auto; z-index:220;
      background:#e9f0ff; border:1px solid #d0dcff; border-radius:16px; padding:16px 46px 16px 16px;
      box-shadow:0 20px 40px rgba(0,0,0,.28); opacity:0;
    }
    #broadcast-banner.show{
      display:block; opacity:1; transform:translate(-50%,-50%) scale(1);
      animation:bannerIn .32s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes bannerIn{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    #broadcast-banner .x{position:absolute;top:10px;right:12px;background:#0000;border:none;font-size:22px;cursor:pointer;color:#2643b8}

    .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid var(--border-color);z-index:120}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--light-text);font-size:12px;cursor:pointer;position:relative;transition: all 0.3s ease;}
    .nav-item.active{color:var(--primary-color);transform: translateY(-2px);}

    .notification{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:var(--success-color);color:#fff;padding:16px 22px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:300;display:none;font-size:14px;text-align:center;min-width:240px;max-width:85%;
    }

    .nav-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 11px;
      font-weight: bold;
      display: none;
      align-items: center;
      justify-content: center;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: pulse 2s infinite;
    }

    .menu-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .menu-item .nav-badge {
      position: static;
      margin-right: auto;
      margin-left: 8px;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .user-info {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .user-details {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 900;
      color: #111;
      font-size: 16px;
      line-height: 1.2;
      margin: 0;
      flex-wrap: wrap;
    }

    .post-time {
      color: var(--light-text);
      font-size: 13px;
      margin-top: 2px;
      line-height: 1.2;
    }

    .post-content {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .post-meta {
      display: flex;
      gap: 8px;
      margin-bottom: 0;
      flex-wrap: wrap;
      align-items: center;
    }

    .post-stage, .post-material, .post-price {
      padding: 4px 8px;
      background: var(--sky);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      color: var(--primary-color);
      line-height: 1.2;
      white-space: nowrap;
    }

    .post-price {
      background: #e8f5e8;
      color: var(--success-color);
    }

    .post-stats {
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0;
    }

    .views-count {
      color: var(--light-text);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .post-actions-new {
      display: grid !important;
      grid-template-columns: 1fr 1fr 1fr !important;
      gap: 8px !important;
      margin-top: 12px !important;
    }

    .post-action-btn {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px !important;
      padding: 12px 8px !important;
      background: transparent !important;
      border: 1px solid var(--border-color) !important;
      border-radius: 8px !important;
      color: var(--light-text) !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      font-size: 14px !important;
      font-weight: 600 !important;
      min-height: 44px !important;
      text-align: center !important;
    }

    .post-action-btn:hover {
      background: var(--sky) !important;
      color: var(--primary-color) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }

    .post-action-btn span {
      display: inline-block !important;
      font-size: 13px !important;
    }

    .telegram-btn {
      background: #0088cc !important;
      color: white !important;
      border-color: #0088cc !important;
    }

    .telegram-btn:hover {
      background: #0077b5 !important;
      transform: translateY(-1px);
    }

    .whatsapp-btn {
      background: #25D366 !important;
      color: white !important;
      border-color: #25D366 !important;
    }

    .whatsapp-btn:hover {
      background: #128C7E !important;
      transform: translateY(-1px);
    }

    .comments-btn {
      background: #FFC107 !important;
      color: #212529 !important;
      border-color: #FFC107 !important;
    }

    .comments-btn:hover {
      background: #E0A800 !important;
      transform: translateY(-1px);
    }

    .report-btn {
      background: #DC3545 !important;
      color: white !important;
      border-color: #DC3545 !important;
    }

    .report-btn:hover {
      background: #C82333 !important;
      transform: translateY(-1px);
    }

    .details-btn {
      background: #6C757D !important;
      color: white !important;
      border-color: #6C757D !important;
    }

    .details-btn:hover {
      background: #5A6268 !important;
      transform: translateY(-1px);
    }

    .details-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      border-right: 4px solid var(--primary-color);
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 700;
      color: #555;
      font-size: 14px;
    }

    .detail-value {
      font-weight: 800;
      color: #222;
      font-size: 14px;
    }

    .cheapest-price {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 900;
      text-align: center;
      margin: 10px 0;
    }

    @media (max-width: 480px) {
      .post {
        padding: 12px;
        margin-bottom: 12px;
        gap: 10px;
      }
      
      .user-name {
        font-size: 15px;
      }
      
      .post-meta {
        gap: 6px;
      }
      
      .post-description {
        padding: 10px;
        font-size: 14px;
      }
      
      .post-actions-new {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 6px !important;
      }
      
      .post-action-btn {
        padding: 10px 6px !important;
        font-size: 12px !important;
        min-height: 40px !important;
      }
      
      .post-action-btn span {
        font-size: 11px !important;
      }
    }

    @media (max-width: 360px) {
      .post-actions-new {
        grid-template-columns: 1fr 1fr 1fr !important;
      }
      
      .post-action-btn {
        padding: 8px 4px !important;
        font-size: 11px !important;
      }
      
      .post-action-btn i {
        font-size: 14px !important;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-icon {
      font-size: 28px;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 600;
    }

    .stat-card:nth-child(1) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card:nth-child(4) {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .user-management-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .user-management-item .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .user-management-item .user-details {
      flex: 1;
    }

    .user-management-item .user-name {
      font-weight: 700;
      color: #111;
    }

    .user-management-item .user-email {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .user-management-item .user-id {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    .user-management-item .user-status {
      font-size: 12px;
      font-weight: 700;
      margin-top: 4px;
    }

    .user-management-item .user-status.banned {
      color: #dc3545;
    }

    .user-management-item .user-status.active {
      color: #28a745;
    }

    .user-management-item .user-actions {
      display: flex;
      gap: 8px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-card {
        min-height: 110px;
        padding: 14px;
      }
      
      .stat-number {
        font-size: 22px;
      }
      
      .user-management-item {
        flex-direction: column;
        align-items: stretch;
      }
      
      .user-management-item .user-actions {
        justify-content: center;
      }
    }

    .menu-item[onclick="logout()"] {
      background: rgba(220, 53, 69, 0.2) !important;
      color: #fff !important;
      border: 1px solid rgba(220, 53, 69, 0.4) !important;
    }

    .menu-item[onclick="logout()"]:hover {
      background: rgba(220, 53, 69, 0.3) !important;
      transform: translateY(-2px);
    }

    .admin-menu {
      padding: 10px;
    }

    .admin-menu .menu-item {
      background: var(--sky);
      border: 1px solid #d0dcff;
    }

    .admin-menu .menu-item:hover {
      background: #e1eaff;
      transform: translateY(-2px);
    }

    .search-box {
      margin-bottom: 15px;
    }

    .search-box input {
      margin-bottom: 10px;
    }

    .avatar-selection {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .avatar-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 15px;
      border-radius: 12px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .avatar-option:hover {
      background: var(--sky);
      transform: translateY(-2px);
    }

    .avatar-option .emo {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .avatar-option .avatar-label {
      font-weight: 600;
      color: var(--primary-color);
    }

    .comment {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      border-right: 3px solid var(--primary-color);
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .comment-user {
      font-weight: 700;
      color: #111;
      font-size: 14px;
    }

    .comment-time {
      color: var(--light-text);
      font-size: 12px;
    }

    .comment-content {
      color: #333;
      line-height: 1.5;
      font-size: 14px;
    }

    .comment-actions {
      display: flex;
      gap: 15px;
      margin-top: 8px;
    }

    .comment-action {
      background: none;
      border: none;
      color: var(--light-text);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .comment-action:hover {
      color: var(--primary-color);
    }

    .privacy-content {
      padding: 20px;
      line-height: 1.6;
    }

    .support-page {
      padding: 20px;
    }

    .support-card {
      background: var(--gradient-success);
      border-radius: 20px;
      padding: 25px;
      color: white;
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
      margin-bottom: 20px;
    }

    .support-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .support-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 15px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .support-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .support-btn i {
      font-size: 20px;
      width: 24px;
    }

    .user-support-page {
      padding: 20px;
    }

    .user-support-item {
      background: #fff;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .user-support-item {
      background: #1e1e1e;
      color: #ffffff;
      border-color: #333;
    }

    .user-support-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .support-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .support-user {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 16px;
    }

    .support-type {
      background: var(--accent-color);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .support-message {
      color: var(--text-color);
      line-height: 1.6;
      margin-bottom: 15px;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .reply-section {
      border-top: 1px dashed var(--border-color);
      padding-top: 12px;
      margin-top: 12px;
    }

    .support-reply-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .support-reply-btn:hover {
      background: #3a5bef;
      transform: translateY(-1px);
    }

    .admin-control-btn {
      background: var(--primary-color) !important;
      color: white !important;
      border: 1px solid var(--primary-color) !important;
    }

    .admin-control-btn:hover {
      background: #3a5bef !important;
      transform: translateY(-2px);
    }
    
    .post-menu {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }

    .post-menu-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .post-menu-btn:hover {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }

    .post-menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 150px;
      display: none;
      z-index: 100;
    }

    [data-theme="dark"] .post-menu-dropdown {
      background: #2a2a2a;
      border-color: #444;
    }

    .post-menu-dropdown.show {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.2s ease;
      font-size: 13px;
      color: var(--text-color);
    }

    .post-menu-item:last-child {
      border-bottom: none;
    }

    .post-menu-item:hover {
      background: var(--sky);
      color: var(--primary-color);
    }

    .post-menu-item i {
      width: 16px;
      text-align: center;
      font-size: 12px;
    }

    #report-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    #report-modal .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 400px;
        color: white;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    #report-modal .modal-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    #report-modal .modal-header i {
        font-size: 24px;
        color: #ffd166;
    }

    #report-modal .modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 900;
    }

    #report-modal .report-reasons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }

    .report-reason-btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 15px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: right;
        backdrop-filter: blur(10px);
    }

    .report-reason-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .report-reason-btn i {
        margin-left: 8px;
        font-size: 16px;
    }

    #report-custom-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 15px;
        color: white;
        font-size: 14px;
        margin-top: 10px;
        resize: vertical;
        min-height: 80px;
        backdrop-filter: blur(10px);
    }

    #report-custom-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    #report-custom-input:focus {
        outline: none;
        border-color: #ffd166;
        box-shadow: 0 0 0 2px rgba(255, 209, 102, 0.3);
    }

    .report-modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .report-modal-actions button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #report-submit-btn {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: #000;
    }

    #report-submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
    }

    #report-cancel-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    #report-cancel-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    #report-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .confirmation-modal .modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .confirmation-modal .modal-header {
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding-bottom: 15px;
    }

    .confirmation-modal .modal-body {
      padding: 20px 0;
      text-align: center;
      font-size: 16px;
      line-height: 1.6;
    }

    .confirmation-modal .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .confirmation-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .confirm-btn {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: #000;
    }

    .confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
    }

    .cancel-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .cancel-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    body {
        touch-action: pan-y;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        text-size-adjust: 100%;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    input, select, textarea {
        font-size: 16px !important;
        max-height: 44px;
    }

    @media screen and (max-width: 768px) {
        input, select, textarea {
            font-size: 16px !important;
        }
    }

    #study-timer-display {
        font-size: 48px;
        font-weight: 900;
        color: var(--primary-color);
        margin: 20px 0;
        font-family: monospace;
        text-align: center;
    }

    #timer-stats {
        margin-top: 20px;
        padding: 15px;
        background: var(--sky);
        border-radius: 10px;
    }

    .sessions-history {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    [data-theme="dark"] .sessions-history {
      background: #2a2a2a;
    }

    .sessions-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .session-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #fff;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .session-item {
      background: #1e1e1e;
    }

    .session-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .session-info {
      flex: 1;
    }

    .session-name {
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .session-duration {
      font-size: 12px;
      color: var(--light-text);
    }

    .session-date {
      font-size: 11px;
      color: #999;
    }

    .session-name-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 15px;
      background: #fff;
      color: #333;
    }

    [data-theme="dark"] .session-name-input {
      background: #333;
      color: #fff;
      border-color: #555;
    }

    .session-name-input::placeholder {
      color: #999;
    }

    [data-theme="dark"] .session-name-input::placeholder {
      color: #777;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--light-text);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    #session-name-modal .modal-content {
    max-width: 400px;
    animation: modalSlideIn 0.3s ease-out;
}

    #session-name-modal input {
        font-size: 16px !important;
        padding: 12px 15px;
        border-radius: 12px;
        margin-top: 8px;
    }

    #session-name-modal input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    #session-name-modal input:focus {
        outline: none;
        border-color: #ffd166;
        box-shadow: 0 0 0 2px rgba(255, 209, 102, 0.3);
    }

    @media (max-width: 480px) {
        #session-name-modal .modal-content {
            width: 90%;
            margin: 10px auto;
            padding: 20px;
        }
    }

    * {
        text-align: right !important;
        direction: rtl !important;
    }

    body, .container, .post, .company, .modal-content {
        text-align: right !important;
        direction: rtl !important;
    }

    .post-header, .user-info, .user-details, .post-content, .post-meta {
        text-align: right !important;
        direction: rtl !important;
    }

    .post-description, .company .desc {
        text-align: right !important;
        direction: rtl !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
    }

    .btn, .post-action-btn, .menu-item {
        text-align: center !important;
        justify-content: center !important;
    }

    .container {
        max-width: 100% !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
    }

    .posts-container {
        padding: 15px !important;
    }

    .header {
        padding: 12px 15px !important;
    }

    .filter-container {
        padding: 15px !important;
        background: #fff !important;
        border-bottom: 1px solid var(--border-color) !important;
    }

    .rank-avatar-container {
        width: 50px !important;
        height: 50px !important;
        flex-shrink: 0 !important;
    }

    .rank-avatar {
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        object-fit: cover !important;
    }

    .user-name {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        flex-wrap: wrap !important;
        line-height: 1.2 !important;
    }

    .post-title {
        font-size: 15px !important;
        font-weight: 800 !important;
        color: var(--primary-color) !important;
        margin-bottom: 8px !important;
    }

    * {
        max-width: 100% !important;
        box-sizing: border-box !important;
    }

    @media (max-width: 480px) {
        .post {
            padding: 12px !important;
            margin-bottom: 12px !important;
            gap: 10px !important;
        }
        
        .post-actions-new {
            grid-template-columns: 1fr 1fr 1fr !important;
            gap: 6px !important;
        }
        
        .post-action-btn {
            padding: 10px 6px !important;
            font-size: 12px !important;
            min-height: 40px !important;
        }
        
        .post-action-btn span {
            font-size: 11px !important;
        }
    }

    [data-theme="dark"] .post,
    [data-theme="dark"] .post-description,
    [data-theme="dark"] .user-name {
        text-align: right !important;
        direction: rtl !important;
    }

    a, button {
        text-decoration: none !important;
        -webkit-tap-highlight-color: transparent !important;
    }

    .post-action-btn, .btn, .menu-item {
        touch-action: manipulation !important;
        min-height: 44px !important;
        min-width: 44px !important;
    }

    #load-more-btn {
        display: block;
        margin: 20px auto;
        padding: 12px 30px;
        background: linear-gradient(135deg, #4a6bff, #6a11cb);
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(74, 107, 255, 0.3);
    }

    #load-more-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 107, 255, 0.4);
    }

    #load-more-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    #load-more-btn i {
        margin-left: 8px;
    }
    
    /* تنسيق عرض العداد الدراسي */
#study-timer-display {
    font-size: 48px;
    font-weight: 900;
    color: var(--primary-color);
    margin: 20px 0;
    font-family: 'Tajawal', monospace;
    text-align: center;
    direction: ltr;
    letter-spacing: 2px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 80px;
    background: linear-gradient(135deg, rgba(74, 107, 255, 0.1), rgba(106, 17, 203, 0.1));
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* تنسيق حاوية العداد */
#study-timer-page .post {
    text-align: center;
    padding: 30px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* تنسيق أزرار التحكم بالعداد */
#study-timer-page .post-actions {
    justify-content: center;
    gap: 15px;
    display: flex;
    flex-wrap: wrap;
    margin-top: 20px;
    width: 100%;
    max-width: 400px;
}

/* تنسيق الإحصائيات */
#timer-stats {
    margin-top: 20px;
    padding: 15px;
    background: var(--sky);
    border-radius: 10px;
    text-align: center;
    width: 100%;
    max-width: 400px;
}

/* تنسيق تاريخ الجلسات */
.sessions-history {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    text-align: center;
}

[data-theme="dark"] .sessions-history {
    background: #2a2a2a;
}

/* تنسيق عناصر الجلسات */
.session-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: #fff;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    text-align: right;
    width: 100%;
}

/* تنسيق محتوى العداد */
#study-timer-page .posts-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 15px;
}

/* إزالة الهوامش البيضاء من الجانبين */
body, html {
    margin: 0;
    padding: 0;
    width: 100%;
    overflow-x: hidden;
}

.container {
    width: 100%;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
    background: #fff;
}

[data-theme="dark"] .container {
    background: #121212;
}

/* إزالة الهوامش من الرأس */
.header {
    width: 100%;
    padding: 12px 15px !important;
    margin: 0 !important;
    border-radius: 0 !important;
}

/* إزالة الهوامش من حاوية المنشورات */
.posts-container {
    width: 100%;
    padding: 15px !important;
    margin: 0 !important;
}

/* إزالة الهوامش من المنشورات */
.post {
    width: 100%;
    max-width: 100% !important;
    margin: 0 0 16px 0 !important;
    border-radius: 14px;
}

/* إزالة الهوامش من شريط الفلاتر */
.filter-container {
    width: 100%;
    padding: 15px !important;
    margin: 0 !important;
    border-radius: 0 !important;
}

/* إزالة الهوامش من الصفحات الأخرى */
.page {
    width: 100%;
    margin: 0 !important;
    padding: 0 !important;
}

/* إزالة الهوامش من عناصر داخلية */
.post-content, .post-description, .user-info, .user-details {
    width: 100%;
    max-width: 100% !important;
}

/* إزالة الهوامش من الشريط السفلي */
.bottom-nav {
    width: 100%;
    margin: 0 !important;
    padding: 12px 0 !important;
    border-radius: 0 !important;
}

/* إزالة أي حواف جانبية في جميع العناصر */
* {
    max-width: 100% !important;
}

/* إصلاح خاص للهواتف */
@media (max-width: 480px) {
    .container {
        padding: 0 !important;
    }
    
    .posts-container {
        padding: 12px !important;
    }
    
    .post {
        padding: 12px !important;
        margin-bottom: 12px !important;
    }
}

/* إصلاح خاص للأجهزة اللوحية */
@media (min-width: 768px) {
    .container {
        padding: 0 !important;
    }
    
    .posts-container {
        padding: 20px !important;
    }
}

/* إصلاح خاص للشاشات الكبيرة */
@media (min-width: 1024px) {
    .posts-container {
        padding: 20px 15px !important;
    }
}

  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>

  <div id="splash" class="splash" aria-label="سوق الطلاب">
    <div class="runner" dir="rtl" aria-hidden="true">
      <span>س</span><span>و</span><span>ق</span><span>&nbsp;</span><span>ا</span><span>ل</span><span>ط</span><span>ل</span><span>ا</span><span>ب</span>
    </div>
    <div class="final-logo" id="final-logo" dir="rtl">سوق الطلاب</div>
    
    <div id="loading-text" class="loading-text" style="display: none;">
      جاري التحميل...
    </div>
  </div>

  <a href="https://youtube.com/shorts/dezFxy0tc9w?si=eoYQNWjjqJ-C599h" target="_blank" class="help-floating-btn" id="help-floating-btn">
    <i class="fas fa-question-circle"></i>
    شرح انشاء حساب جديد
  </a>

  <div id="auth-page" class="auth-container page" style="display:none">
    <div class="auth-box">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">تسجيل الدخول</div>
        <div class="auth-tab" onclick="switchAuthTab('register')">إنشاء حساب</div>
      </div>

      <form id="login-form" class="auth-form active" onsubmit="event.preventDefault(); login();">
        <div class="form-group"><label for="login-email">البريد الإلكتروني</label><input type="email" id="login-email" class="form-control" required></div>
        <div class="form-group"><label for="login-password">كلمة المرور</label><input type="password" id="login-password" class="form-control" required></div>
        <div class="form-group" style="text-align:center; margin-top:10px;">
          <a href="#" onclick="openForgotPasswordModal()" style="color:var(--primary-color); text-decoration:none; font-size:14px;">
            نسيت كلمة المرور؟
          </a>
        </div>
        <button type="submit" class="btn btn-block">تسجيل الدخول</button>
      </form>

      <form id="register-form" class="auth-form" onsubmit="event.preventDefault(); register();">
        <div class="form-group"><label for="register-name">الاسم الكامل</label><input type="text" id="register-name" class="form-control" required></div>
        <div class="form-group"><label for="register-email">البريد الإلكتروني</label><input type="email" id="register-email" class="form-control" required></div>
        <div class="form-group"><label for="register-password">كلمة المرور</label><input type="password" id="register-password" class="form-control" required></div>
        
        <div class="form-group">
          <label>الصورة الشخصية</label>
          <div class="avatar-upload-section">
            <div class="avatar-upload-btn-large" onclick="document.getElementById('register-avatar-input').click()">
              <i class="fas fa-camera"></i>
              <span>رفع صورة</span>
            </div>
            <img id="register-avatar-preview" class="avatar-preview-small" alt="معاينة الصورة">
            <input type="file" id="register-avatar-input" accept="image/*" style="display: none" onchange="previewRegisterAvatar(event)">
          </div>
        </div>
        
        <button type="button" id="register-submit" class="btn btn-block" onclick="register()">إنشاء حساب</button>
      </form>
    </div>
  </div>

  <div id="main-page" class="container page" style="display:none">
    <div class="header">
      <div class="brand">
        <button id="create-btn" class="btn" onclick="onCreateButton()"><i class="fas fa-plus"></i> <span id="create-btn-label">إنشاء منشور</span></button>
        <div class="section-switch" role="tablist" aria-label="الأقسام">
          <button id="pill-posts" class="section-pill active" onclick="switchSection('posts')" role="tab" aria-selected="true">المنشورات</button>
          <button id="pill-companies" class="section-pill" onclick="switchSection('companies')" role="tab" aria-selected="false">شركات التوصيل</button>
        </div>
      </div>
    </div>

    <div id="filter-container" class="filter-container">
      <select id="filter-stage" class="filter-select" onchange="renderPosts()">
        <option value="">كل المراحل</option>
        <option value="sades-elmi">السادس العلمي</option>
        <option value="sades-adabi">السادس الادبي</option>
        <option value="khames">الخامس علمي/ادبي</option>
        <option value="rabea">الرابع علمي/ادبي</option>
        <option value="thaleth-mut">الثالث متوسط</option>
        <option value="thani-mut">الثاني متوسط</option>
        <option value="awal-mut">الاول متوسط</option>
        <option value="sades-ibtidai">السادس الابتدائي</option>
      </select>
      <select id="filter-material" class="filter-select" onchange="renderPosts()">
        <option value="">كل المواد</option>
        <option value="اسلامية">اسلامية</option><option value="عربي">عربي</option><option value="انكليزي">انكليزي</option>
        <option value="رياضيات">رياضيات</option><option value="احياء">احياء</option><option value="كيمياء">كيمياء</option>
        <option value="فيزياء">فيزياء</option><option value="اقتصاد">اقتصاد</option><option value="أدب ونصوص">أدب ونصوص</option>
        <option value="قواعد">قواعد</option>
      </select>
    </div>

    <div class="pull-indicator"><div id="pull-bubble" class="bubble">اسحب للتحديث…</div></div>
    <div class="posts-container" id="posts-container"></div>
    <div class="posts-container" id="companies-container" style="display:none"></div>
  </div>

  <div class="pull-indicator">
    <div id="pull-bubble" class="bubble" style="display: none">
      <i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...
    </div>
  </div>

  <div id="profile-page" class="container page" style="display:none">
    <div class="profile-shell">
      <div class="profile-card">
        <button class="theme-toggle-btn" onclick="toggleTheme()">
          <i class="fas fa-moon"></i>
        </button>
        
        <div class="avatar-container">
            <div id="avatar" class="avatar" title="انقر لتغيير الصورة" onclick="openAvatarModal()">
                <div style="width:100%;height:100%;font-size:40px;line-height:72px">👨🏻‍💼</div>
            </div>
            <div class="avatar-upload-btn" onclick="openImageUploadModal()" title="رفع صورة شخصية">
                <i class="fas fa-camera"></i>
            </div>
        </div>
        <div class="profile-meta">
          <div class="profile-name-row">
            <span id="profile-name"></span>
            <span id="profile-verified"></span>
            <i class="fas fa-pencil-alt" style="color:white;cursor:pointer" onclick="editProfileName()"></i>
          </div>
          <div id="profile-count" class="profile-count"></div>
          <div id="profile-email" class="profile-email"></div>
          <div class="row" style="align-items: center; gap: 8px; margin-top:4px;">
            <input id="profile-uid-input" class="form-control profile-uid-input" readonly />
            <button class="btn btn-xs" onclick="copyUidToClipboard()" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.5);"><i class="fas fa-copy"></i> نسخ</button>
          </div>
        </div>
      </div>
      
      <div class="profile-actions-card">
        <div class="profile-menu">
          <div class="menu-item" onclick="showUserPosts()">
            <i class="fas fa-book"></i>
            <span>منشوراتي</span>
          </div>
          
          <div class="menu-item" onclick="showInbox();">
            <i class="fas fa-inbox"></i>
            <span>البريد الوارد</span>
            <div id="inbox-badge" class="nav-badge" style="display: none">0</div>
          </div>
          
          <div class="menu-item" onclick="showSupportPage()">
            <i class="fas fa-headset"></i>
            <span>التواصل مع الدعم</span>
          </div>
          
          <div class="menu-item owner-only" style="display:none" onclick="showAdminPanel()">
            <i class="fas fa-cogs"></i>
            <span>لوحة التحكم</span>
          </div>
          
          <div class="menu-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>تسجيل الخروج</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="user-posts-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">منشوراتي</span></div>
    <div class="posts-container" id="user-posts-container"></div>
  </div>

  <div id="inbox-page" class="container page" style="display:none">
  <div class="header">
    <button class="btn btn-secondary" onclick="backToProfile()">
      <i class="fas fa-arrow-right"></i>
    </button>
    <span style="font-weight:900">البريد الوارد</span>
    <button id="mark-all-read-btn" class="btn btn-success btn-xs" onclick="markAllNotificationsAsRead()" style="margin-right: auto;">
      <i class="fas fa-check-double"></i> قراءة الكل
    </button>
  </div>
  <div class="posts-container" id="inbox-container"></div>
</div>

  <div id="details-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromDetails()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">تفاصيل المنشور</span></div>
    <div class="posts-container" id="details-container"></div>
  </div>

  <div id="comments-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromComments()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">التعليقات</span></div>
    <div class="posts-container">
      <div id="comments-list-page"></div>
      <div class="row" style="margin-top:10px;">
        <input type="text" id="comment-text-page" class="form-control grow" placeholder="أضف تعليقًا...">
        <button id="send-comment-btn" class="btn" onclick="addCommentFromPage()">إرسال</button>
      </div>
    </div>
  </div>

  <div id="user-statistics-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">إحصائيات المستخدمين</span>
    </div>
    <div class="posts-container">
      <div class="stats-grid" id="stats-grid">
      </div>
    </div>
  </div>

  <div id="admin-panel-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
        <span style="font-weight:900">لوحة التحكم</span>
    </div>
    <div class="posts-container">
        <div class="admin-menu">
            <div class="menu-item admin-control-btn" onclick="showUserStatistics()">
                <i class="fas fa-chart-bar"></i>
                <span>إحصائيات المستخدمين</span>
            </div>
            
            <div class="menu-item admin-control-btn" onclick="showUserManagement()">
                <i class="fas fa-users-cog"></i>
                <span>إدارة المستخدمين</span>
            </div>
            <div class="menu-item admin-control-btn" onclick="showBroadcastPanel()">
                <i class="fas fa-bullhorn"></i>
                <span>إشعار عام</span>
            </div>
            <div class="menu-item admin-control-btn" onclick="showUserSupportPage()">
                <i class="fas fa-comments"></i>
                <span>الرد على المستخدمين</span>
            </div>
        </div>
    </div>
</div>

  <div id="user-management-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">إدارة المستخدمين</span>
    </div>
    <div class="posts-container">
      <div class="search-box" style="margin-bottom: 15px;">
        <input type="text" id="user-search-input" class="form-control" placeholder="ابحث بالبريد الإلكتروني أو ID...">
        <button class="btn" onclick="searchUsers()" style="margin-top: 10px; width: 100%;">بحث</button>
      </div>
      <div id="user-management-results"></div>
    </div>
  </div>

  <div id="broadcast-panel-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">إشعار عام</span>
    </div>
    <div class="posts-container">
      <div class="post">
        <div class="form-group">
          <label>عنوان الإشعار</label>
          <input type="text" id="broadcast-title" class="form-control" placeholder="أدخل عنوان الإشعار...">
        </div>
        <div class="form-group">
          <label>محتوى الرسالة</label>
          <textarea id="broadcast-message" class="form-control" rows="6" placeholder="أدخل محتوى الإشعار..."></textarea>
        </div>
        <div class="post-actions">
          <button class="btn btn-success" onclick="sendBroadcast()">
            <i class="fas fa-paper-plane"></i> إرسال الإشعار
          </button>
        </div>
      </div>
    </div>
  </div>


  <div id="support-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">التواصل مع الدعم</span>
    </div>
    <div class="support-page">
      <div class="support-card">
        <h2 style="margin-bottom: 15px; text-align: center;">مرحباً بك في مركز الدعم</h2>
        
        <div class="support-actions">
          <button class="support-btn" onclick="contactTelegram()">
            <i class="fab fa-telegram"></i>
            <span>التواصل مباشرة عبر التيليجرام</span>
          </button>
          
          <button class="support-btn" onclick="openSuggestionModal()">
            <i class="fas fa-lightbulb"></i>
            <span>إرسال اقتراح للتطبيق</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="user-support-page" class="container page" style="display:none">
  <div class="header">
    <button class="btn btn-secondary" onclick="backToAdminPanel()">
      <i class="fas fa-arrow-right"></i>
    </button>
    <span style="font-weight:900">الرد على المستخدمين</span>
    <button id="mark-support-read-btn" class="btn btn-success btn-xs" onclick="markAllSupportAsRead()" style="margin-right: auto;">
      <i class="fas fa-check-double"></i> قراءة الكل
    </button>
  </div>
  <div class="user-support-page" id="user-support-container">
    <div id="user-support-results">
      <div class="post">
        <p style="text-align: center; color: var(--text-color);">جاري تحميل طلبات الدعم...</p>
      </div>
    </div>
  </div>
</div>

<div id="bottom-nav" class="bottom-nav" style="display: none;">
    <div class="nav-item active" data-page="main" onclick="showMainPageAndClearBadge();">
        <i class="fas fa-home"></i>
        <span>المنشورات</span>
        <div id="posts-badge" class="nav-badge" style="display: none">0</div>
    </div>
    
    <div class="nav-item" data-page="study-timer" onclick="showStudyTimerPage()">
        <i class="fas fa-clock"></i>
        <span>العداد الدراسي</span>
    </div>
    
    <div class="nav-item" data-page="profile" onclick="showProfilePage()">
        <i class="fas fa-user"></i>
        <span>حسابي</span>
        <div id="profile-notification-badge" class="nav-badge" style="display: none">0</div>
    </div>
</div>

  <div id="notification" class="notification"></div>

  <div id="create-post-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>إنشاء منشور</h2><button class="close-modal" onclick="closeCreatePostModal()">&times;</button></div>
    
    <div class="select-group">
      <label>المرحلة <span style="color:var(--danger-color)">*</span></label>
      <select id="post-stage" class="select-control" required>
        <option value="" disabled selected>اختر مرحلتك</option>
        <option value="sades-elmi">السادس العلمي</option>
        <option value="sades-adabi">السادس الادبي</option>
        <option value="khames">الخامس العلمي والادبي</option>
        <option value="rabea">الرابع العلمي والادبي</option>
        <option value="thaleth-mut">الثالث متوسط</option>
        <option value="thani-mut">الثاني متوسط</option>
        <option value="awal-mut">الاول متوسط</option>
        <option value="sades-ibtidai">السادس الابتدائي</option>
      </select>
    </div>
    
    <div class="select-group"><label>المادة</label>
      <select id="post-material" class="select-control">
        <option>اسلامية</option><option>عربي</option><option>انكليزي</option>
        <option>رياضيات</option><option>احياء</option><option>كيمياء</option>
        <option>فيزياء</option><option>اقتصاد</option><option>أدب ونصوص</option><option>قواعد</option>
      </select>
    </div>
    
    <div class="select-group"><label>السعر</label><input id="post-price" class="select-control" type="number" value="0"></div>
    
    <div class="select-group">
      <label>أرخص سعر للملزمة (اختياري)</label>
      <input id="post-cheapest-price" class="select-control" type="number" value="0" placeholder="أدخل أرخص سعر للملزمة...">
    </div>
    
    <div class="select-group"><label>الوصف</label><textarea id="post-description" class="select-control" rows="4" placeholder="اكتب وصف المنشور هنا..."></textarea></div>
    
    <div class="select-group"><label>طريقة التواصل</label>
      <select id="contact-method" class="select-control" onchange="changeContactMethod()">
        <option value="whatsapp">واتساب</option>
        <option value="telegram">تلكرام</option>
        <option value="comments">تعليقات</option>
      </select>
    </div>
    <div id="whatsapp-field" class="select-group"><label>رقم واتساب</label><input id="whatsapp-number" class="select-control" placeholder="9647xxxxxxxxx"></div>
    <div id="telegram-field" class="select-group" style="display:none"><label>معرّف تلكرام</label><input id="telegram-username" class="select-control" placeholder="username بدون @"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCreatePostModal()">إلغاء</button>
      <button id="post-submit-btn" class="btn" onclick="createPost()">
        <i class="fas fa-paper-plane"></i> نشر
      </button>
    </div>
  </div></div>

  <div id="edit-post-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>تعديل منشور</h2><button class="close-modal" onclick="closeEditPostModal()">&times;</button></div>
    <input type="hidden" id="edit-post-id"/>
    <div class="select-group"><label>المرحلة</label>
      <select id="edit-post-stage" class="select-control">
        <option value="sades-elmi">السادس العلمي</option>
        <option value="sades-adabi">السادس الادبي</option>
        <option value="khames">الخامس</option>
        <option value="rabea">الرابع</option>
        <option value="thaleth-mut">الثالث متوسط</option>
        <option value="thani-mut">الثاني متوسط</option>
        <option value="awal-mut">الاول متوسط</option>
        <option value="sades-ibtidai">السادس الابتدائي</option>
      </select>
    </div>
    <div class="select-group"><label>السعر</label><input id="edit-post-price" class="select-control" type="number"></div>
    
    <div class="select-group">
      <label>أرخص سعر للملزمة</label>
      <input id="edit-post-cheapest-price" class="select-control" type="number" placeholder="أدخل أرخص سعر للملزمة...">
    </div>
    
    
    <div class="select-group"><label>المادة</label>
      <select id="edit-post-material" class="select-control">
        <option>اسلامية</option><option>عربي</option><option>انكليزي</option>
        <option>رياضيات</option><option>احياء</option><option>كيمياء</option>
        <option>فيزياء</option><option>اقتصاد</option><option>أدب ونصوص</option><option>قواعد</option>
      </select>
    </div>
    <div class="select-group"><label>الوصف</label><textarea id="edit-post-description" class="select-control" rows="4"></textarea></div>
    <div class="select-group"><label>طريقة التواصل</label>
      <select id="edit-contact-method" class="select-control" onchange="changeContactMethod('edit')">
        <option value="whatsapp">واتساب</option>
        <option value="telegram">تلكرام</option>
        <option value="comments">تعليقات</option>
      </select>
    </div>
    <div id="edit-whatsapp-field" class="select-group"><label>رقم واتساب</label><input id="edit-whatsapp-number" class="select-control"></div>
    <div id="edit-telegram-field" class="select-group" style="display:none"><label>معرّف تلكرام</label><input id="edit-telegram-username" class="select-control"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEditPostModal()">إلغاء</button>
      <button id="post-edit-submit-btn" class="btn" onclick="savePostEdits()">حفظ</button>
    </div>
  </div></div>

  <div id="create-company-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>إضافة شركة توصيل</h2><button class="close-modal" onclick="closeCreateCompanyModal()">&times;</button></div>
    <div class="select-group"><label>اسم الشركة</label><input id="company-name" class="select-control"></div>
    <div class="select-group"><label>من</label><select id="company-from" class="select-control"></select></div>
    <div class="select-group"><label>إلى</label><select id="company-to" class="select-control"></select></div>
    <div class="select-group"><label>الهاتف</label><input id="company-phone" class="select-control"></div>
    <div class="select-group"><label>وصف</label><textarea id="company-desc" class="select-control" rows="3"></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCreateCompanyModal()">إلغاء</button>
      <button id="company-submit-btn" class="btn btn-success" onclick="createCompany()">إضافة</button>
    </div>
  </div></div>

  <div id="image-upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>رفع صورة شخصية</h2>
            <button class="close-modal" onclick="closeImageUploadModal()">&times;</button>
        </div>
        <div class="select-group">
            <label>اختر صورة</label>
            <input type="file" id="avatar-upload-input" accept="image/*" class="form-control">
        </div>
        <div id="avatar-preview" style="text-align: center; margin: 15px 0; display: none;">
            <img id="avatar-preview-img" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #4a6bff;">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImageUploadModal()">إلغاء</button>
            <button id="upload-avatar-btn" class="btn btn-success" onclick="uploadAvatar()" disabled>رفع الصورة</button>
        </div>
    </div>
  </div>

  <div id="avatar-modal" class="modal"><div class="modal-content">
    <div class="modal-header">
      <h2>تغيير الصورة الشخصية</h2><button class="close-modal" onclick="closeAvatarModal()">&times;</button></div>
    
    <div class="avatar-selection">
      <label class="avatar-option" onclick="setAvatar('male')">
        <span class="emo">👨🏻‍💼</span>
        <span class="avatar-label">ولد</span>
      </label>
      
      <label class="avatar-option" onclick="setAvatar('female')">
        <span class="emo">👩🏻‍💼</span>
        <span class="avatar-label">بنت</span>
      </label>
    </div>

    <div style="text-align: center; margin-top: 20px; padding: 15px; background: var(--sky); border-radius: 12px;">
      <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-color);">الصورة الحالية:</div>
      <div id="current-avatar-preview" style="display: inline-block;"></div>
    </div>
  </div></div>

  <div id="forgot-password-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>استعادة كلمة المرور</h2>
        <button class="close-modal" onclick="closeForgotPasswordModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>البريد الإلكتروني</label>
        <input type="email" id="forgot-email" class="select-control" placeholder="أدخل بريدك الإلكتروني المسجل">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeForgotPasswordModal()">إلغاء</button>
        <button id="forgot-submit-btn" class="btn btn-success" onclick="handleForgotPassword()">إرسال رابط الاستعادة</button>
      </div>
    </div>
  </div>

  <div id="suggestion-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>إرسال اقتراح أو مشكلة</h2>
        <button class="close-modal" onclick="closeSuggestionModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>نوع الرسالة</label>
        <select id="suggestion-type" class="select-control">
          <option value="problem">مشاكل في التطبيق</option>
          <option value="suggestion">اقتراح للتطبيق</option>
        </select>
      </div>
      <div class="select-group">
        <label>الوصف</label>
        <textarea id="suggestion-message" class="select-control" rows="6" placeholder="اكتب وصف المشكلة أو الاقتراح بالتفصيل..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSuggestionModal()">إلغاء</button>
        <button class="btn btn-success" onclick="sendSuggestion()">
          <i class="fas fa-paper-plane"></i> إرسال
        </button>
      </div>
    </div>
  </div>

  <div id="reply-support-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>الرد على المستخدم</h2>
        <button class="close-modal" onclick="closeReplySupportModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>معرف المستخدم</label>
        <input type="text" id="reply-user-id" class="select-control" readonly>
      </div>
      <div class="select-group">
        <label>اسم المستخدم</label>
        <input type="text" id="reply-user-name" class="select-control" readonly>
      </div>
      <div class="select-group">
        <label>الرد</label>
        <textarea id="reply-message" class="select-control" rows="6" placeholder="اكتب ردك على المستخدم..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeReplySupportModal()">إلغاء</button>
        <button class="btn btn-success" onclick="sendSupportReply()">
          <i class="fas fa-paper-plane"></i> إرسال الرد
        </button>
      </div>
    </div>
  </div>

  <div id="broadcast-overlay"></div>
  <div id="broadcast-banner">
    <button class="x" onclick="dismissBroadcast()">×</button>
    <div style="font-weight:900;color:#0f235f" id="broadcast-title-display"></div>
    <div id="broadcast-text-display" style="margin-top:4px;color:#0f235f"></div>
  </div>
  
<div id="report-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <i class="fas fa-flag"></i>
            <h2>الإبلاغ عن منشور</h2>
        </div>
        
        <div class="report-reasons">
            <button class="report-reason-btn" onclick="selectReportReason('محتوى غير لائق')">
                <i class="fas fa-ban"></i>
                محتوى غير لائق
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('احتيال أو نصاب')">
                <i class="fas fa-user-slash"></i>
                احتيال أو نصاب
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('مخالف للشروط')">
                <i class="fas fa-exclamation-triangle"></i>
                مخالف للشروط
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('معلومات خاطئة')">
                <i class="fas fa-times-circle"></i>
                معلومات خاطئة
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('سبب آخر')">
                <i class="fas fa-edit"></i>
                سبب آخر
            </button>
        </div>
        
        <textarea 
            id="report-custom-input" 
            placeholder="اكتب سبب الإبلاغ بالتفصيل... (اختياري)"
            style="display: none;"
        ></textarea>
        
        <div class="report-modal-actions">
            <button id="report-cancel-btn" onclick="closeReportModal()">
                إلغاء
            </button>
            <button id="report-submit-btn" onclick="submitReport()" disabled>
                <i class="fas fa-paper-plane"></i> إرسال الإبلاغ
            </button>
        </div>
    </div>
</div>

<div id="confirmation-modal" class="modal confirmation-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="confirmation-title">تأكيد الإجراء</h2>
            <button class="close-modal" onclick="closeConfirmationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmation-message">هل أنت متأكد من تنفيذ هذا الإجراء؟</p>
        </div>
        <div class="modal-footer">
            <button class="confirmation-btn cancel-btn" onclick="closeConfirmationModal()">إلغاء</button>
            <button class="confirmation-btn confirm-btn" id="confirmation-confirm-btn">تأكيد</button>
        </div>
    </div>
</div>

<div id="study-timer-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudyAssistantPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">العداد الدراسي</span>
    </div>
    
    <div class="posts-container">
        <div class="post" style="text-align: center; padding: 30px 20px;">
            <div id="study-timer-display" style="font-size: 48px; font-weight: 900; color: var(--primary-color); margin: 20px 0; font-family: monospace;">
                00:00:00
            </div>
            
            <div class="post-actions" style="justify-content: center; gap: 15px;">
                <button id="start-timer-btn" class="btn btn-success" onclick="startStudyTimer()">
                    <i class="fas fa-play"></i> بدء
                </button>
                <button id="pause-timer-btn" class="btn btn-warning" onclick="pauseStudyTimer()" disabled>
                    <i class="fas fa-pause"></i> إيقاف مؤقت
                </button>
                <button id="stop-timer-btn" class="btn btn-danger" onclick="stopStudyTimer()" disabled>
                    <i class="fas fa-stop"></i> انتهيت
                </button>
            </div>
            
            <div id="timer-stats" style="margin-top: 20px; padding: 15px; background: var(--sky); border-radius: 10px; display: none;">
                <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 10px;">إحصائيات الدراسة</div>
                <div id="session-time"></div>
                <div id="total-time"></div>
            </div>
            
            <div class="sessions-history">
                <h3 style="margin-bottom: 15px; text-align: center; color: var(--primary-color);">
                    <i class="fas fa-history"></i> آخر 5 جلسات
                </h3>
                <div id="sessions-list" class="sessions-list">
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>لا توجد جلسات سابقة</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="session-name-modal" class="modal">
    <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; padding: 25px;">
        <div class="modal-header">
            <h2 style="margin: 0; font-size: 20px; font-weight: 900;">تسمية الجلسة الدراسية</h2>
            <button class="close-modal" onclick="closeSessionNameModal()">&times;</button>
        </div>
        <div class="select-group" style="margin: 20px 0;">
            <label style="color: white; margin-bottom: 10px; display: block;">اكتب اسم الجلسة الدراسية</label>
            <input type="text" id="modal-session-name" class="form-control" placeholder="مثال: جلسة لحل واجب الرياضيات..." style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;">
        </div>
        <div class="modal-footer" style="text-align: center;">
            <button class="btn btn-success" onclick="confirmSessionName()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: #000; border: none; padding: 12px 24px;">
                <i class="fas fa-play"></i> بدء الجلسة
            </button>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkoSz3ZUy4qKBTeLx42Oo-TlTtvFtF2vY",
  authDomain: "we-kill-the-sixth.firebaseapp.com",
  databaseURL: "https://we-kill-the-sixth-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "we-kill-the-sixth",
  storageBucket: "we-kill-the-sixth.firebasestorage.app",
  messagingSenderId: "862363949793",
  appId: "1:862363949793:web:e0dc01a4eb139da43f75a0",
  measurementId: "G-CT6WFGXRHH"
};

let db, auth, storage;
try {
  firebase.initializeApp(firebaseConfig);
  
  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();
  
  firebase.firestore().enablePersistence()
    .catch(err => console.log("Firestore persistence error:", err));
    
} catch (error) {
  console.error("Firebase initialization failed:", error);
  setTimeout(() => {
    const loadingText = document.getElementById('loading-text');
    if (loadingText) {
      loadingText.innerHTML = 'خطأ في الاتصال بقاعدة البيانات<br><small>تحقق من اتصال الإنترنت</small>';
      loadingText.style.color = '#ff6b6b';
    }
  }, 4000);
}

const APP_OWNER_EMAIL = "mslmalmyaly223@gmail.com";

let currentUser = null;
let posts = [];
let companies = [];
let activeSection = "posts";
let currentDetailsPostId = null;
let currentCommentsPostId = null;
const userMetaCache = {};
let lastBroadcast = null;
let isFirstLoginSession = false;

let unreadNotifications = { inbox: 0, newPosts: 0 };
let unreadPostsCount = 0;
let notificationsListener = null;
let postsListener = null;

let registerAvatarBase64 = null;

let pages = {};

let studyTimer = {
    startTime: parseInt(localStorage.getItem('studyTimerStartTime')) || null,
    totalSeconds: parseInt(localStorage.getItem('studyTimerTotalSeconds')) || 0,
    isRunning: localStorage.getItem('studyTimerIsRunning') === 'true',
    isPaused: localStorage.getItem('studyTimerIsPaused') === 'true',
    interval: null,
    currentSessionName: localStorage.getItem('currentSessionName') || ''
};

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  const themeIcon = document.querySelector('.theme-toggle-btn i');
  if (themeIcon) {
    themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
  
  showNotification(newTheme === 'dark' ? 'تم تفعيل الوضع الليلي' : 'تم تفعيل الوضع النهاري');
}

function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  const themeIcon = document.querySelector('.theme-toggle-btn i');
  if (themeIcon) {
    themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
}

function previewRegisterAvatar(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('register-avatar-preview');
  
  if (file) {
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    const maxSize = 2 * 1024 * 1024;
    
    if (!validTypes.includes(file.type)) {
      showNotification('نوع الملف غير مدعوم');
      return;
    }
    
    if (file.size > maxSize) {
      showNotification('حجم الملف كبير جداً');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      registerAvatarBase64 = e.target.result;
    }
    reader.readAsDataURL(file);
  }
}

function openImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'block';
    document.getElementById('avatar-upload-input').value = '';
    document.getElementById('avatar-preview').style.display = 'none';
    document.getElementById('upload-avatar-btn').disabled = true;
}

function closeImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'none';
}

function initializeImageUpload() {
    const uploadInput = document.getElementById('avatar-upload-input');
    if (uploadInput) {
        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('avatar-preview');
            const previewImg = document.getElementById('avatar-preview-img');
            const uploadBtn = document.getElementById('upload-avatar-btn');
            
            if (file) {
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                const maxSize = 2 * 1024 * 1024;
                
                if (!validTypes.includes(file.type)) {
                    showNotification('نوع الملف غير مدعوم');
                    return;
                }
                
                if (file.size > maxSize) {
                    showNotification('حجم الملف كبير جداً');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    uploadBtn.disabled = false;
                }
                reader.readAsDataURL(file);
            }
        });
    }
}

async function uploadAvatar() {
    const fileInput = document.getElementById('avatar-upload-input');
    const file = fileInput.files[0];
    
    if (!file || !currentUser) return;
    
    const uploadBtn = document.getElementById('upload-avatar-btn');
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'جاري الحفظ...';
    
    try {
        const compressedImage = await compressImage(file);
        
        await db.collection('users').doc(currentUser.uid).update({
            avatarBase64: compressedImage,
            avatarUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentUser.avatarBase64 = compressedImage;
        updateAvatarDisplay();
        
        showNotification('تم حفظ الصورة بنجاح!');
        closeImageUploadModal();
        
    } catch (error) {
        console.error('خطأ في الرفع:', error);
        showNotification('فشل حفظ الصورة');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'رفع الصورة';
    }
}

function compressImage(file, maxWidth = 200, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      ctx.drawImage(img, 0, 0, width, height);
      
      const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
      resolve(compressedBase64);
    };
    
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

function updateAvatarDisplay() {
  const avatarElement = document.getElementById('avatar');
  if (!avatarElement) return;
  
  if (currentUser.avatarBase64) {
    avatarElement.innerHTML = `<img src="${currentUser.avatarBase64}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
  } else {
    const emoji = currentUser.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    avatarElement.innerHTML = `<div style="width:100%;height:100%;font-size:40px;line-height:72px">${emoji}</div>`;
  }
}

function showNotification(msg, type = "success") {
  const n = document.getElementById("notification");
  n.textContent = msg;
  n.style.display = "block";
  const colors = { error: '#ff6b6b', warning: '#ffc107', info: '#4a6bff', success: '#28a745' };
  n.style.backgroundColor = colors[type] || colors.success;
  clearTimeout(n._t);
  n._t = setTimeout(() => { n.style.display = "none"; }, 2600);
}

function escapeHTML(s = '') {
  return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
}

function formatWhatsApp(v) {
  let num = (v || "").toString().replace(/[^\d]/g, "");
  if (num.startsWith('07') && num.length === 11) { return '964' + num.substring(1); }
  if (num.startsWith('96407') && num.length === 14) { return '964' + num.substring(4); }
  return num;
}

function sanitizeTelegram(v) {
  return (v || "").toString().replace(/^@+/, "").trim();
}

function openTelegram(username) {
  username = sanitizeTelegram(username);
  if (!username) return;
  window.open("https://t.me/" + username, '_blank');
}

function openWhatsApp(number) {
  if (!number) return;
  window.open("https://wa.me/" + number, '_blank');
}

function copyUidToClipboard() {
  const el = document.getElementById('profile-uid-input');
  if (!el) return;
  el.select();
  el.setSelectionRange(0, 99999);
  document.execCommand('copy');
  showNotification('تم النسخ');
}

function isOwner() {
  return currentUser && (currentUser.email === APP_OWNER_EMAIL);
}

function generateShortUid(uid) {
  if (!uid) return '';
  let hash = 0;
  for (let i = 0; i < uid.length; i++) {
    hash = ((hash << 5) - hash) + uid.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36).substring(0, 5).toUpperCase();
}

function formatPriceWithZeros(price) {
  const num = Number(price);
  if (isNaN(num)) return '0';
  
  if (num < 1000 && num > 0) {
    return num.toString() + '000'.slice(num.toString().length);
  }
  
  return num.toString();
}

function hideSplashAfterLoad() {
  const splash = document.getElementById('splash');
  if (splash) {
    splash.classList.add('fade-out');
    setTimeout(() => {
      splash.remove();
    }, 600);
  }
}

function showMainPageAndClearBadge() {
  clearPostsBadge();
  showPage("main");
  
  // تحديث الشريط السفلي
  document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
    item.classList.remove("active");
    if (item.dataset.page === "main") {
      item.classList.add("active");
    }
  });
}

function updateLoadingText(text) {
  const loadingText = document.getElementById('loading-text');
  if (loadingText) {
    loadingText.textContent = text;
    loadingText.style.display = 'block';
    loadingText.classList.add('show');
  }
}

function handleAuthError(error) {
  const code = (error && error.code) || '';
  const msg = (error && error.message) ? String(error.message) : '';
  let friendly = 'خطأ مصادقة.';
  if (code === 'auth/user-not-found' || code === 'auth/wrong-password' || msg.includes('INVALID_LOGIN_CREDENTIALS')) {
    friendly = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
  } else if (code === 'auth/invalid-email') {
    friendly = 'صيغة البريد الإلكتروني غير صحيحة.';
  } else if (code === 'auth/network-request-failed') {
    friendly = 'تحقّق من اتصال الإنترنت.';
  } else if (code === 'auth/too-many-requests') {
    friendly = 'محاولات كثيرة. حاول لاحقًا.';
  } else if (code === 'auth/email-already-in-use') {
    friendly = 'هذا البريد مسجّل مسبقًا.';
  }
  showNotification(friendly, 'error');
}

async function register() {
  const name = document.getElementById("register-name").value.trim();
  const email = document.getElementById("register-email").value.trim().toLowerCase();
  const password = document.getElementById("register-password").value;
  
  if (!name || !email || !password) return showNotification("يرجى ملء جميع الحقول", "error");
  if (!validateEmail(email)) return showNotification("البريد الإلكتروني غير صالح", "error");
  
  const btn = document.getElementById("register-submit");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري إنشاء الحساب...';
  
  try {
    updateLoadingText('جاري إنشاء الحساب...');
    
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const shortUid = generateShortUid(cred.user.uid);
    
    updateLoadingText('جاري حفظ بياناتك...');
    
    const userData = {
      name, email, 
      avatar: 'male',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      isVerified: false, 
      isOwner: false, 
      blockedFromPosting: false,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      shortUid: shortUid
    };
    
    if (registerAvatarBase64) {
      userData.avatarBase64 = registerAvatarBase64;
    }
    
    await db.collection("users").doc(cred.user.uid).set(userData, { merge: true });
    
    localStorage.setItem('userSignupTime', Date.now().toString());
    
    showNotification("تم إنشاء حسابك بنجاح!");
    switchAuthTab('login');
    
    registerAvatarBase64 = null;
    document.getElementById('register-avatar-preview').style.display = 'none';
    
  } catch (error) {
    handleAuthError(error);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function login() {
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;
  if (!email || !password) return showNotification("يرجى ملء جميع الحقول", "error");
  
  const btn = document.querySelector('#login-form button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تسجيل الدخول…';
  
  try {
    updateLoadingText('جاري تسجيل الدخول...');
    await auth.signInWithEmailAndPassword(email, password);
    
    setTimeout(() => {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }, 1000);
    
  } catch (error) {
    handleAuthError(error);
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function logout() {
  const keysToRemove = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.includes('_cache') || key.includes('_time')) {
      keysToRemove.push(key);
    }
  }
  
  keysToRemove.forEach(key => {
    localStorage.removeItem(key);
  });
  
  stopAllListeners();
  auth.signOut();
}

auth.onAuthStateChanged(async (user) => {
  const isConnected = await checkFirebaseConnection();
  if (!isConnected) {
    updateLoadingText("فشل الاتصال بالخادم - تحقق من الإنترنت");
    setTimeout(hideSplashAfterLoad, 2000);
    return;
  }
  
  if (!user) {
    updateUIForLoggedOutUser();
    hideSplashAfterLoad();
    return;
  }
  
  try {
    updateLoadingText('جاري تحميل بيانات الحساب...');
    
    let doc = await db.collection("users").doc(user.uid).get();
    
    if (!doc.exists) {
      isFirstLoginSession = true;
      const shortUid = generateShortUid(user.uid);
      await db.collection("users").doc(user.uid).set({
        name: user.displayName || user.email.split("@")[0],
        email: user.email,
        avatar: 'male',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        isVerified: false, isOwner: false, blockedFromPosting: false,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        shortUid: shortUid
      }, { merge: true });
      doc = await db.collection("users").doc(user.uid).get();
      localStorage.setItem('userSignupTime', Date.now().toString());
    } else {
      isFirstLoginSession = false;
      db.collection("users").doc(user.uid).update({
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(console.error);
    }
    
    currentUser = { uid: user.uid, ...doc.data() };
    
    if (doc.data().avatarBase64) {
      currentUser.avatarBase64 = doc.data().avatarBase64;
    }
    
    updateUIForLoggedInUser();
    
    updateLoadingText('جاري تحميل المنشورات...');
    
    await Promise.all([
      loadPostsFromFirestore(), 
      loadCompanies()
    ]);
    
    if (!isFirstLoginSession) {
      await fetchLatestBroadcast();
    }
    
    startAllListeners();
    
    hideSplashAfterLoad();
    
  } catch (e) {
    console.error("Error in auth state change:", e);
    showNotification("خطأ في تحميل البيانات", "error");
    hideSplashAfterLoad();
  }
});

function initializePages() {
  pages = {
    auth: document.getElementById("auth-page"),
    main: document.getElementById("main-page"),
    profile: document.getElementById("profile-page"),
    userPosts: document.getElementById("user-posts-page"),
    inbox: document.getElementById("inbox-page"),
    details: document.getElementById("details-page"),
    comments: document.getElementById("comments-page"),
    userStatistics: document.getElementById("user-statistics-page"),
    adminPanel: document.getElementById("admin-panel-page"),
    userManagement: document.getElementById("user-management-page"),
    broadcastPanel: document.getElementById("broadcast-panel-page"),
    support: document.getElementById("support-page"),
    userSupport: document.getElementById("user-support-page"), 
    "study-timer-page": document.getElementById("study-timer-page")
  };
}

function showPage(key) {
  if (Object.keys(pages).length === 0) {
    initializePages();
  }
  
  Object.values(pages).forEach(p => p && (p.style.display = "none"));
  if (!pages[key]) {
    return;
  }
  pages[key].style.display = (key === "auth") ? "flex" : "block";
  updateBottomNav(key);
  updateAllBadges();
  
  const helpBtn = document.getElementById('help-floating-btn');
  if (helpBtn) {
    helpBtn.style.display = (key === "auth") ? 'flex' : 'none';
  }
  
  if (key === "userSupport") {
    loadUserSupportRequests();
  }
  
  if (key === "study-timer-page") {
    initializeStudyTimer();
    loadStudySessions();
  }
}

function updateBottomNav(activePageKey) {
  document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
    // إزالة الكلاس النشط من جميع العناصر
    item.classList.remove("active");
    
    // إضافة الكلاس النشط للعنصر المناسب
    if (item.dataset.page === activePageKey) {
      item.classList.add("active");
    }
  });
}

function showMainPage() {
  clearPostsBadge();
  showPage("main");
}

function showInbox() {
  if (!currentUser) return showNotification('سجّل الدخول', 'warning');
  showPage('inbox');
}

function showProfilePage() {
  showPage("profile");
  
  // تحديث الشريط السفلي
  document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
    item.classList.remove("active");
    if (item.dataset.page === "profile") {
      item.classList.add("active");
    }
  });
}

function backToProfile() {
  showPage("profile");
}

function backToMainFromDetails() {
  showPage("main");
}

function backToMainFromComments() {
  showPage("main");
}

function backToAdminPanel() {
  showPage("adminPanel");
}

function switchAuthTab(tab) {
  document.querySelectorAll(".auth-tab, .auth-form").forEach(el => el.classList.remove("active"));
  if (tab === "login") {
    document.querySelector(".auth-tab:nth-child(1)").classList.add("active");
    document.getElementById("login-form").classList.add("active");
  } else {
    document.querySelector(".auth-tab:nth-child(2)").classList.add("active");
    document.getElementById("register-form").classList.add("active");
  }
}

function updateUIForLoggedInUser() {
  showPage("main");
  
  document.getElementById("bottom-nav").style.display = "flex";
  
  document.getElementById("profile-name").textContent = currentUser.name || "";
  document.getElementById("profile-email").textContent = currentUser.email || "";
  const shortUid = currentUser.shortUid || generateShortUid(currentUser.uid);
  document.getElementById("profile-uid-input").value = shortUid || "";
  
  updateAvatarDisplay();
  
  const pv = document.getElementById("profile-verified");
  pv.innerHTML = currentUser.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : '';
  document.querySelectorAll(".owner-only").forEach(el => el.style.display = isOwner() ? "flex" : "none");

  updateCreateButton();
  updatePostCountInProfile();
  updateNavBadges();
  
  if (isOwner()) {
    setTimeout(() => {
      createAdminBadges();
      calculateSupportRequests();
      setInterval(calculateSupportRequests, 30000);
    }, 1000);
  }
}

function createAdminBadges() {
  if (!isOwner()) return;
  
  const adminMenuItem = document.querySelector('.menu-item[onclick="showAdminPanel()"]');
  if (adminMenuItem && !document.getElementById('admin-panel-badge')) {
    const adminBadge = document.createElement('div');
    adminBadge.id = 'admin-panel-badge';
    adminBadge.className = 'nav-badge admin-badge';
    adminBadge.style.display = 'none';
    adminBadge.style.position = 'absolute';
    adminBadge.style.top = '-5px';
    adminBadge.style.left = '-5px';
    adminBadge.style.background = 'linear-gradient(135deg, #ff3b3b, #ff6b6b)';
    adminBadge.style.color = 'white';
    adminBadge.style.borderRadius = '50%';
    adminBadge.style.width = '20px';
    adminBadge.style.height = '20px';
    adminBadge.style.fontSize = '11px';
    adminBadge.style.fontWeight = 'bold';
    adminBadge.style.display = 'none';
    adminBadge.style.alignItems = 'center';
    adminBadge.style.justifyContent = 'center';
    adminBadge.style.border = '2px solid #fff';
    adminBadge.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    adminBadge.style.animation = 'pulse 2s infinite';
    adminBadge.style.zIndex = '10';
    
    adminMenuItem.style.position = 'relative';
    adminMenuItem.appendChild(adminBadge);
  }
  
  const supportMenuItem = document.querySelector('.menu-item[onclick="showUserSupportPage()"]');
  if (supportMenuItem && !document.getElementById('user-support-badge')) {
    const supportBadge = document.createElement('div');
    supportBadge.id = 'user-support-badge';
    supportBadge.className = 'nav-badge support-badge';
    supportBadge.style.display = 'none';
    supportBadge.style.position = 'absolute';
    supportBadge.style.top = '-5px';
    supportBadge.style.left = '-5px';
    supportBadge.style.background = 'linear-gradient(135deg, #ff6b6b, #ff8e6b)';
    supportBadge.style.color = 'white';
    supportBadge.style.borderRadius = '50%';
    supportBadge.style.width = '20px';
    supportBadge.style.height = '20px';
    supportBadge.style.fontSize = '11px';
    supportBadge.style.fontWeight = 'bold';
    supportBadge.style.display = 'none';
    supportBadge.style.alignItems = 'center';
    supportBadge.style.justifyContent = 'center';
    supportBadge.style.border = '2px solid #fff';
    supportBadge.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    supportBadge.style.animation = 'pulse 2s infinite';
    supportBadge.style.zIndex = '10';
    
    supportMenuItem.style.position = 'relative';
    supportMenuItem.appendChild(supportBadge);
  }
  
  const profileBadge = document.getElementById('profile-notification-badge');
  if (profileBadge) {
    profileBadge.style.background = 'linear-gradient(135deg, #4a6bff, #6a11cb)';
  }
}

function updateUIForLoggedOutUser() {
  showPage("auth");
  document.getElementById("bottom-nav").style.display = "none";
  if (window.postsContainer) window.postsContainer.innerHTML = "";
  if (window.companiesContainer) window.companiesContainer.innerHTML = "";
  posts = [];
  companies = [];
  currentUser = null;
  document.getElementById("broadcast-banner")?.classList.remove('show');
  document.getElementById("broadcast-overlay")?.classList.remove('show');
}

async function showUserStatistics() {
  if (!isOwner()) {
    showNotification('للمالك فقط', 'error');
    return;
  }
  showPage("userStatistics");
  await loadUserStatistics();
}

async function loadUserStatistics() {
  const statsGrid = document.getElementById("stats-grid");
  if (!statsGrid) return;

  statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-icon">👥</div>
      <div class="stat-number" id="total-users">0</div>
      <div class="stat-label">إجمالي المستخدمين</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">🟢</div>
      <div class="stat-number" id="active-now">0</div>
      <div class="stat-label">نشطين الآن</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">📅</div>
      <div class="stat-number" id="active-today">0</div>
      <div class="stat-label">نشطين اليوم</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">📝</div>
      <div class="stat-number" id="total-posts">0</div>
      <div class="stat-label">إجمالي المنشورات</div>
    </div>
  `;

  try {
    const usersSnapshot = await db.collection("users").get();
    const totalUsers = usersSnapshot.size;
    document.getElementById("total-users").textContent = totalUsers;

    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
    let activeNow = 0;
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const lastSeen = userData.lastSeen?.toDate?.();
      if (lastSeen && lastSeen > fiveMinutesAgo) {
        activeNow++;
      }
    });
    document.getElementById("active-now").textContent = activeNow;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let activeToday = 0;
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const lastSeen = userData.lastSeen?.toDate?.();
      if (lastSeen && lastSeen > today) {
        activeToday++;
      }
    });
    document.getElementById("active-today").textContent = activeToday;

    const postsSnapshot = await db.collection("posts").get();
    document.getElementById("total-posts").textContent = postsSnapshot.size;

  } catch (error) {
    showNotification("خطأ في تحميل الإحصائيات", "error");
  }
}

function showSupportPage() {
  showPage("support");
}

function contactTelegram() {
  window.open("https://t.me/mslmh19", "_blank");
}

function openSuggestionModal() {
  document.getElementById('suggestion-modal').style.display = 'block';
}

function closeSuggestionModal() {
  document.getElementById('suggestion-modal').style.display = 'none';
}

async function sendSuggestion() {
  if (!currentUser) return showNotification('يرجى تسجيل الدخول أولاً', 'error');
  
  const type = document.getElementById('suggestion-type').value;
  const message = document.getElementById('suggestion-message').value.trim();
  
  if (!message) {
    return showNotification('يرجى كتابة وصف المشكلة أو الاقتراح', 'error');
  }
  
  const btn = document.querySelector('#suggestion-modal .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  
  try {
    const ownerQuery = await db.collection('users')
      .where('email', '==', APP_OWNER_EMAIL)
      .limit(1)
      .get();
    
    if (ownerQuery.empty) return;
    
    const ownerDoc = ownerQuery.docs[0];
    const ownerUid = ownerDoc.id;
    
    await db.collection('inbox').add({
      userId: ownerUid,
      type: 'support_request',
      supportType: type,
      title: type === 'problem' ? '🚨 مشكلة جديدة' : '💡 اقتراح جديد',
      message: `👤 المستخدم: ${currentUser.name || 'مستخدم'}\n📧 البريد: ${currentUser.email}\n🆔 المعرف: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}\n📝 النوع: ${type === 'problem' ? 'مشكلة' : 'اقتراح'}\n💬 الرسالة: ${message}`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userUid: currentUser.uid,
      userName: currentUser.name
    });
    
    showNotification('تم إرسال رسالتك بنجاح');
    closeSuggestionModal();
    
  } catch (error) {
    showNotification('فشل إرسال الرسالة', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function showAdminPanel() {
  if (!isOwner()) return showNotification('للمالك فقط', 'error');
  showPage("adminPanel");
}

async function showUserManagement() {
  if (!isOwner()) return;
  showPage("userManagement");
  document.getElementById("user-management-results").innerHTML = '<div class="post"><p>استخدم مربع البحث للعثور على المستخدمين</p></div>';
}

async function searchUsers() {
  if (!isOwner()) return;
  
  const searchTerm = document.getElementById("user-search-input").value.trim().toLowerCase();
  if (!searchTerm) {
    showNotification("يرجى إدخال مصطلح البحث", "error");
    return;
  }

  const resultsContainer = document.getElementById("user-management-results");
  resultsContainer.innerHTML = '<div class="post"><p>جاري البحث...</p></div>';

  try {
    const usersSnapshot = await db.collection("users").get();
    const filteredUsers = [];

    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const userEmail = userData.email?.toLowerCase() || '';
      const userId = doc.id.toLowerCase();
      const shortUid = userData.shortUid?.toLowerCase() || '';
      
      if (userEmail.includes(searchTerm) || userId.includes(searchTerm) || shortUid.includes(searchTerm)) {
        filteredUsers.push({ id: doc.id, ...userData });
      }
    });

    if (filteredUsers.length === 0) {
      resultsContainer.innerHTML = '<div class="post"><p>لا توجد نتائج</p></div>';
      return;
    }

    resultsContainer.innerHTML = filteredUsers.map(user => `
      <div class="post user-management-item">
        <div class="user-info">
          <div class="avatar" style="background: ${user.avatar === 'female' ? '#ffd7ea' : '#d7e4ff'}; width: 40px; height: 40px; font-size: 20px;">
            ${user.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼'}
          </div>
          <div class="user-details">
            <div class="user-name">${escapeHTML(user.name || 'مستخدم')}</div>
            <div class="user-email">${escapeHTML(user.email || '')}</div>
            <div class="user-id">ID: ${user.shortUid || user.id.substring(0, 8)}</div>
            <div class="user-status ${user.blockedFromPosting ? 'banned' : 'active'}">
              ${user.blockedFromPosting ? '🚫 محظور' : '✅ نشط'}
            </div>
          </div>
        </div>
        <div class="user-actions">
          <button class="btn ${user.blockedFromPosting ? 'btn-success' : 'btn-danger'} btn-xs" 
                  onclick="toggleUserBan('${user.id}', ${user.blockedFromPosting})">
            <i class="fas fa-${user.blockedFromPosting ? 'check' : 'ban'}"></i>
            ${user.blockedFromPosting ? 'فك الحظر' : 'حظر المستخدم'}
          </button>
        </div>
      </div>
    `).join('');

  } catch (error) {
    resultsContainer.innerHTML = '<div class="post"><p>خطأ في البحث</p></div>';
  }
}

async function toggleUserBan(userId, isCurrentlyBanned) {
  if (!isOwner()) return;
  
  const action = isCurrentlyBanned ? 'فك الحظر' : 'الحظر';
  if (!confirm(`هل أنت متأكد من ${action} هذا المستخدم؟`)) return;

  try {
    await db.collection("users").doc(userId).update({
      blockedFromPosting: !isCurrentlyBanned,
      banUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showNotification(`تم ${action} المستخدم بنجاح`);
    setTimeout(() => searchUsers(), 1000);
  } catch (error) {
    showNotification("فشل في تنفيذ العملية", "error");
  }
}

function showBroadcastPanel() {
  if (!isOwner()) return;
  showPage("broadcastPanel");
}

async function sendBroadcast() {
  if (!isOwner()) return;
  
  const title = document.getElementById("broadcast-title").value.trim();
  const message = document.getElementById("broadcast-message").value.trim();
  
  if (!title || !message) {
    showNotification("يرجى ملء جميع الحقول", "error");
    return;
  }

  const btn = document.querySelector('#broadcast-panel-page .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';

  try {
    await db.collection("broadcasts").add({
      title: title,
      message: message,
      text: message,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      sentBy: currentUser.uid,
      sentByName: currentUser.name
    });

    showNotification("تم إرسال الإشعار بنجاح");
    
    document.getElementById("broadcast-title").value = "";
    document.getElementById("broadcast-message").value = "";
    
  } catch (error) {
    showNotification("فشل في إرسال الإشعار", "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function showUserSupportPage() {
  if (!isOwner()) return;
  showPage("userSupport");
}

async function loadUserSupportRequests() {
  const container = document.getElementById('user-support-results');
  if (!container) return;
  
  container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">جاري تحميل طلبات الدعم...</p></div>';
  
  try {
    const supportQuery = await db.collection('inbox')
      .orderBy('createdAt', 'desc')
      .limit(50)
      .get();
    
    if (supportQuery.empty) {
      container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">لا توجد طلبات دعم حالياً</p></div>';
      return;
    }
    
    const supportRequests = supportQuery.docs
      .map(doc => ({
        id: doc.id,
        ...doc.data()
      }))
      .filter(request => 
        request.type === 'support_request' || 
        request.type === 'admin_report'
      );
    
    if (supportRequests.length === 0) {
      container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">لا توجد طلبات دعم حالياً</p></div>';
      return;
    }
    
    container.innerHTML = supportRequests.map(request => {
      const requestTime = request.createdAt?.toDate ? formatRelativeTime(request.createdAt.toDate()) : 'غير معروف';
      const typeText = request.supportType === 'problem' ? 'مشكلة' : 'اقتراح';
      const typeIcon = request.supportType === 'problem' ? '🚨' : '💡';
      const statusColor = request.status === 'resolved' ? '#28a745' : '#ffc107';
      
      return `
        <div class="user-support-item">
          <div class="support-meta">
            <div class="support-user">
              ${typeIcon} ${escapeHTML(request.userName || 'مستخدم')}
            </div>
            <div class="support-type" style="background: ${statusColor}">
              ${request.status === 'resolved' ? 'تم الرد' : typeText}
            </div>
          </div>
          
          <div class="support-message">
            ${escapeHTML(request.message || '')}
          </div>
          
          <div class="reply-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <small style="color: #777;">${requestTime}</small>
              <small style="color: #777;">ID: ${request.userUid?.substring(0, 8) || 'غير معروف'}</small>
            </div>
            
            ${request.status !== 'resolved' ? `
            <button class="support-reply-btn" onclick="openReplySupportModal('${request.userUid}', '${escapeHTML(request.userName || 'مستخدم')}', '${request.id}')">
              <i class="fas fa-reply"></i> الرد على المستخدم
            </button>
            ` : `
            <div style="color: #28a745; font-weight: bold; text-align: center;">
              <i class="fas fa-check-circle"></i> تم الرد على هذه الرسالة
            </div>
            `}
          </div>
        </div>
      `;
    }).join('');
    
  } catch (error) {
    container.innerHTML = `
      <div class="post">
        <p style="text-align: center; color: #ff6b6b;">
          خطأ في تحميل طلبات الدعم
        </p>
        <button class="btn" onclick="loadUserSupportRequests()" style="margin-top: 10px;">
          <i class="fas fa-redo"></i> إعادة المحاولة
        </button>
      </div>
    `;
  }
}

function openReplySupportModal(userId, userName, requestId) {
  document.getElementById('reply-user-id').value = userId;
  document.getElementById('reply-user-name').value = userName;
  document.getElementById('reply-support-modal').setAttribute('data-request-id', requestId);
  document.getElementById('reply-support-modal').style.display = 'block';
}

function closeReplySupportModal() {
  document.getElementById('reply-support-modal').style.display = 'none';
  document.getElementById('reply-message').value = '';
}

async function sendSupportReply() {
  const userId = document.getElementById('reply-user-id').value;
  const userName = document.getElementById('reply-user-name').value;
  const replyMessage = document.getElementById('reply-message').value.trim();
  const requestId = document.getElementById('reply-support-modal').getAttribute('data-request-id');
  
  if (!replyMessage) {
    return showNotification('يرجى كتابة الرد', 'error');
  }
  
  const btn = document.querySelector('#reply-support-modal .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  
  try {
    await db.collection('inbox').add({
      userId: userId,
      type: 'support_reply',
      title: '📬 رد على طلب الدعم',
      message: `مرحباً ${userName},\n\n${replyMessage}\n\nمع تحيات فريق الدعم - سوق الطلاب`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      repliedBy: currentUser.uid,
      repliedByName: currentUser.name
    });
    
    if (requestId) {
      await db.collection('inbox').doc(requestId).update({
        status: 'resolved',
        resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        resolvedBy: currentUser.uid
      });
    }
    
    showNotification('تم إرسال الرد بنجاح');
    closeReplySupportModal();
    loadUserSupportRequests();
    
  } catch (error) {
    showNotification('فشل إرسال الرد', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function switchSection(section) {
  activeSection = section;
  if (window.pillPosts) window.pillPosts.classList.toggle("active", section === "posts");
  if (window.pillCompanies) window.pillCompanies.classList.toggle("active", section !== "posts");
  if (window.postsContainer) window.postsContainer.style.display = section === "posts" ? "block" : "none";
  if (window.companiesContainer) window.companiesContainer.style.display = section !== "posts" ? "block" : "none";
  if (window.filterBox) window.filterBox.style.display = section === "posts" ? "flex" : "none";
  updateCreateButton();
  
  if (section === "posts") {
    postsOffset = 0;
    loadPostsFromFirestore(false);
  }
}

function updateCreateButton() {
  if (!window.createBtnLabel) return;
  window.createBtnLabel.textContent = activeSection === "posts" ? "إنشاء منشور" : "إضافة شركة";
  const showForPosts = activeSection === "posts" && currentUser;
  const showForCompanies = activeSection !== "posts" && isOwner();
  if (window.createBtn) window.createBtn.style.display = (showForPosts || showForCompanies) ? "inline-flex" : "none";
}

function onCreateButton() {
  if (activeSection === "posts") openCreatePostModal();
  else openCreateCompanyModal();
}

let postsLimit = 10;
let postsOffset = 0;
let allPosts = [];
let displayPosts = [];

async function loadPostsFromFirestore(loadMore = false) {
  try {
    if (!loadMore) {
      postsOffset = 0;
      postsLimit = 10;
      allPosts = [];
      displayPosts = [];
    }
    
    const cacheKey = 'posts_cache';
    const cacheTime = 'posts_cache_time';
    const now = Date.now();
    const cacheExpiry = 60 * 1000;
    
    const cachedPosts = localStorage.getItem(cacheKey);
    const cacheTimestamp = localStorage.getItem(cacheTime);
    
    if (cachedPosts && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry && !loadMore) {
      allPosts = JSON.parse(cachedPosts);
      displayPosts = allPosts.slice(0, postsLimit);
      posts = displayPosts;
      renderPosts();
      updatePostCountInProfile();
      return;
    }
    
    const snap = await db.collection("posts")
      .orderBy("createdAt", "desc")
      .limit(100)
      .get();
      
    allPosts = snap.docs.map(d => {
      const data = d.data();
      const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(0);
      return { 
        id: d.id, 
        isPinned: !!data.isPinned, 
        commentsCount: data.commentsCount || 0,
        cheapestPrice: data.cheapestPrice || 0,
        ...data, 
        createdAt 
      };
    });
    
    allPosts = allPosts.filter(p => p.status !== 'deleted' && p.status !== 'sold');
    
    allPosts.sort((a, b) => {
      if (a.isPinned && !b.isPinned) return -1;
      if (!a.isPinned && b.isPinned) return 1;
      return (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0);
    });
    
    localStorage.setItem(cacheKey, JSON.stringify(allPosts));
    localStorage.setItem(cacheTime, now.toString());
    
    if (!loadMore) {
      displayPosts = allPosts.slice(0, postsLimit);
      postsOffset = postsLimit;
    } else {
      const nextPosts = allPosts.slice(postsOffset, postsOffset + postsLimit);
      displayPosts = [...displayPosts, ...nextPosts];
      postsOffset += postsLimit;
    }
    
    posts = displayPosts;
    renderPosts();
    updatePostCountInProfile();
    
  } catch (e) {
    const cachedPosts = localStorage.getItem('posts_cache');
    if (cachedPosts && !loadMore) {
      allPosts = JSON.parse(cachedPosts);
      displayPosts = allPosts.slice(0, postsLimit);
      posts = displayPosts;
      renderPosts();
      updatePostCountInProfile();
    }
  }
}

async function loadMorePosts() {
  if (postsOffset >= allPosts.length) {
    showNotification("لا توجد منشورات إضافية", "info");
    return;
  }
  
  const loadMoreBtn = document.getElementById('load-more-btn');
  if (loadMoreBtn) {
    loadMoreBtn.disabled = true;
    loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
  }
  
  await loadPostsFromFirestore(true);
  
  if (loadMoreBtn) {
    loadMoreBtn.disabled = false;
    loadMoreBtn.innerHTML = '<i class="fas fa-plus"></i> عرض المزيد';
  }
}

async function renderPosts() {
  if (!window.postsContainer) {
    return;
  }
  
  window.postsContainer.innerHTML = "";
  const filterMaterial = document.getElementById('filter-material').value;
  const filterStage = document.getElementById('filter-stage').value;
  
  const sorted = [...posts].sort((a, b) => {
    if (a.isPinned && !b.isPinned) return -1;
    if (!a.isPinned && b.isPinned) return 1;
    return (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0);
  });
  
  const filtered = sorted.filter(p => {
    const isVisible = p.status !== 'sold' && p.status !== 'deleted';
    const materialMatch = !filterMaterial || p.material === filterMaterial;
    const stageMatch = !filterStage || p.stage === filterStage;
    return isVisible && materialMatch && stageMatch;
  });
  
  if (filtered.length === 0) {
    window.postsContainer.innerHTML = '<div class="post"><p>لا توجد منشورات تطابق الفلتر</p></div>';
    return;
  }
  
  const uids = [...new Set(filtered.map(p => p.userId).filter(Boolean))];
  await Promise.all(uids.map(async uid => {
    if (!userMetaCache[uid]) userMetaCache[uid] = await getUserMeta(uid);
  }));
  
  const frag = document.createDocumentFragment();
  
  for (const post of filtered) {
    const meta = userMetaCache[post.userId] || { isVerified: false, blockedFromPosting: false, avatar: 'male', avatarBase64: null };
    const postElement = createPostElement(post, meta, 'list');
    frag.appendChild(postElement);
  }
  
  window.postsContainer.appendChild(frag);
  
  if (postsOffset < allPosts.length) {
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.id = 'load-more-btn';
    loadMoreBtn.className = 'btn';
    loadMoreBtn.style.cssText = 'margin: 20px auto; display: block; padding: 12px 30px; background: #4a6bff; color: white; border-radius: 25px;';
    loadMoreBtn.innerHTML = '<i class="fas fa-plus"></i> عرض المزيد';
    loadMoreBtn.onclick = loadMorePosts;
    
    window.postsContainer.appendChild(loadMoreBtn);
  }
}

async function getUserMeta(uid) {
  if (userMetaCache[uid]) return userMetaCache[uid];
  try {
    const u = await db.collection("users").doc(uid).get();
    const data = u.data();
    const meta = { 
      isVerified: !!data?.isVerified, 
      blockedFromPosting: !!data?.blockedFromPosting,
      avatar: data?.avatar || 'male',
      avatarBase64: data?.avatarBase64 || null,
      createdAt: data?.createdAt
    };
    userMetaCache[uid] = meta;
    return meta;
  } catch {
    return { isVerified: false, blockedFromPosting: false, avatar: 'male', avatarBase64: null, createdAt: null };
  }
}

function priceLabelFromNumber(price) {
  const priceValue = Number(price);
  if (!isNaN(priceValue) && priceValue === 0) return 'مجاناً';
  try { return `${priceValue.toLocaleString('ar-IQ')} د.ع`; } catch { return `${priceValue} د.ع`; }
}

function stageLabel(stage) {
  const map = {
    "sades-elmi": "السادس العلمي", "sades-adabi": "السادس الادبي", "khames": "الخامس",
    "rabea": "الرابع", "thaleth-mut": "الثالث متوسط", "thani-mut": "الثاني متوسط",
    "awal-mut": "الاول متوسط", "sades-ibtidai": "السادس الابتدائي"
  };
  return map[stage] || "";
}

function formatRelativeTime(date) {
  if (!date) return 'غير معروف';
  
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffMins < 1) return 'الآن';
  if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
  if (diffHours < 24) return `منذ ${diffHours} ساعة`;
  if (diffDays < 7) return `منذ ${diffDays} يوم`;
  
  return date.toLocaleDateString('ar-IQ');
}

function createPostElement(post, meta, context = 'list') {
  const card = document.createElement("div");
  card.className = `post ${post.isPinned ? 'pinned' : ''} ${post.status === 'sold' ? 'sold' : ''}`;
  
  const postTime = formatRelativeTime(post.createdAt);
  
  const verifiedBadge = meta.isVerified ? 
    `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : '';
  
  const pinBadge = post.isPinned ? 
    '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> مثبت</div>' : '';
  
  let ownerTools = '';
  if (isOwner() && context === 'list') {
    const pinTxt = post.isPinned ? 'إلغاء التثبيت' : 'تثبيت';
    const verTxt = meta.isVerified ? 'إلغاء التوثيق' : 'توثيق';
    const banTxt = meta.blockedFromPosting ? 'إلغاء حظر النشر' : 'حظر النشر';
    ownerTools = `
      <div class="owner-tools">
        <button class="btn btn-xs" onclick="ownerTogglePin('${post.id}', ${post.isPinned})">
          <i class="fa-solid fa-thumbtack"></i> ${pinTxt}
        </button>
        <button class="btn btn-xs" onclick="ownerToggleVerify('${post.userId}')">
          <i class="fa-solid fa-crown"></i> ${verTxt}
        </button>
        <button class="btn btn-xs" onclick="ownerToggleUserBanById('${post.userId}')">
          <i class="fa-solid fa-ban"></i> ${banTxt}
        </button>
        <button class="btn btn-danger btn-xs" onclick="ownerDeletePost('${post.id}')">
          <i class="fa-solid fa-trash"></i> حذف
        </button>
      </div>
    `;
  }
  
  let postMenu = '';
  if (currentUser && post.userId === currentUser.uid && context === 'list') {
    postMenu = `
      <div class="post-menu">
        <button class="post-menu-btn" onclick="togglePostMenu(this)">
          <i class="fas fa-ellipsis-v"></i>
        </button>
        <div class="post-menu-dropdown">
          <div class="post-menu-item" onclick="openEditPostModal('${post.id}')">
            <i class="fas fa-edit"></i>
            <span>تعديل</span>
          </div>
          <div class="post-menu-item" onclick="markSoldWithConfirmation('${post.id}', ${post.status === 'sold'})">
            <i class="fas fa-tag"></i>
            <span>${post.status === 'sold' ? 'إلغاء البيع' : 'تم البيع'}</span>
          </div>
          <div class="post-menu-item" onclick="repost('${post.id}')">
            <i class="fas fa-sync"></i>
            <span>إعادة نشر</span>
          </div>
          <div class="post-menu-item" onclick="deletePostWithConfirmation('${post.id}')" style="color: #ff6b6b;">
            <i class="fas fa-trash"></i>
            <span>حذف</span>
          </div>
        </div>
      </div>
    `;
  }
  
  let contactButton = '';
  if (post.contactMethod === "whatsapp" && post.whatsapp) {
    contactButton = `
      <button class="post-action-btn whatsapp-btn" onclick="openWhatsApp('${post.whatsapp}')">
        <i class="fab fa-whatsapp"></i>
        <span>واتساب</span>
      </button>
    `;
  } else if (post.contactMethod === "telegram" && post.telegram) {
    contactButton = `
      <button class="post-action-btn telegram-btn" onclick="openTelegram('${post.telegram}')">
        <i class="fab fa-telegram"></i>
        <span>تلكرام</span>
      </button>
    `;
  } else if (post.contactMethod === "comments") {
    contactButton = `
      <button class="post-action-btn comments-btn" onclick="openCommentsPage('${post.id}')">
        <i class="fas fa-comment"></i>
        <span>تعليق</span>
      </button>
    `;
  }
  
  const detailsButton = `
    <button class="post-action-btn details-btn" onclick="openDetailsPage('${post.id}')">
      <i class="fas fa-question-circle"></i>
      <span>تفاصيل</span>
    </button>
  `;

  const reportButton = `
    <button class="post-action-btn report-btn" onclick="reportPost('${post.id}')">
        <i class="fas fa-flag"></i>
        <span>إبلاغ</span>
    </button>
  `;
  
  let userAvatarHtml = '';
  if (meta.avatarBase64) {
    userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
  }
  
  const priceLabel = priceLabelFromNumber(post.price);
  const stageLabelText = stageLabel(post.stage);
  
  const commentsCount = post.commentsCount || 0;
  
  card.innerHTML = `
    ${pinBadge}
    ${postMenu}
    ${ownerTools}
    
    <div class="post-header">
      <div class="user-info">
        <div class="rank-avatar-container">
          ${userAvatarHtml}
        </div>
        <div class="user-details">
          <div class="user-name">
            ${escapeHTML(post.userName || 'مستخدم')}
            ${verifiedBadge}
          </div>
          <div class="post-time">${postTime}</div>
        </div>
      </div>
    </div>
    
    <div class="post-content">
      <div class="post-meta">
        <span class="post-stage">${stageLabelText}</span>
        <span class="post-material">${escapeHTML(post.material || '')}</span>
        <span class="post-price">${priceLabel}</span>
      </div>
      
      <div class="post-description">
        ${escapeHTML(post.description || '')}
      </div>
    </div>
    
    ${post.contactMethod === "comments" ? `
<div class="post-stats">
  <span class="views-count">
    <i class="fas fa-comments"></i>
    <span>${commentsCount} تعليق</span>
  </span>
</div>
` : ''}
    
    <div class="post-actions-new">
      ${contactButton}
      ${detailsButton}
      ${reportButton}
    </div>
  `;
  
  return card;
}

function togglePostMenu(button) {
  const dropdown = button.nextElementSibling;
  const isShowing = dropdown.classList.contains('show');
  
  document.querySelectorAll('.post-menu-dropdown.show').forEach(menu => {
    if (menu !== dropdown) {
      menu.classList.remove('show');
    }
  });
  
  dropdown.classList.toggle('show', !isShowing);
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.post-menu')) {
    document.querySelectorAll('.post-menu-dropdown.show').forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

function openCreatePostModal() {
  resetCreatePostForm();
  document.getElementById("create-post-modal").style.display = "block";
}

function closeCreatePostModal() {
  document.getElementById('create-post-modal').style.display = 'none';
  resetCreatePostForm();
}

function openAvatarModal() {
  renderAvatarPreview();
  document.getElementById('avatar-modal').style.display = 'block';
}

function closeAvatarModal() {
  document.getElementById('avatar-modal').style.display = 'none';
}

function resetCreatePostForm() {
  document.getElementById("post-stage").value = "";
  document.getElementById("post-description").value = "";
  document.getElementById("post-price").value = "0";
  document.getElementById("post-cheapest-price").value = "0";
  document.getElementById("whatsapp-number").value = "";
  document.getElementById("telegram-username").value = "";
  changeContactMethod();
}

function changeContactMethod(prefix = '') {
  const methodEl = document.getElementById(`${prefix ? 'edit-' : ''}contact-method`);
  const w_field = document.getElementById(`${prefix ? 'edit-' : ''}whatsapp-field`);
  const t_field = document.getElementById(`${prefix ? 'edit-' : ''}telegram-field`);
  const method = methodEl ? methodEl.value : '';
  if (w_field) w_field.style.display = method === "whatsapp" ? "block" : "none";
  if (t_field) t_field.style.display = method === "telegram" ? "block" : "none";
}

let createPostBusy = false;
async function createPost() {
  if (createPostBusy) return;
  if (!currentUser) return showNotification("يرجى تسجيل الدخول أولاً", "error");
  
  const stage = document.getElementById("post-stage").value.trim();
  if (!stage) {
    return showNotification("يرجى اختيار مرحلتك", "error");
  }
  
  try {
    const udoc = await db.collection("users").doc(currentUser.uid).get();
    if (udoc.exists && udoc.data()?.blockedFromPosting) {
      return showNotification("تم حظرك من النشر", "error");
    }
  } catch (e) { }

  const price = document.getElementById("post-price").value.trim();
  const cheapestPrice = document.getElementById("post-cheapest-price").value.trim();
  const material = document.getElementById("post-material").value;
  const description = document.getElementById("post-description").value.trim();
  const contactMethod = document.getElementById("contact-method").value;
  const whatsapp = formatWhatsApp(document.getElementById("whatsapp-number").value);
  const telegram = sanitizeTelegram(document.getElementById("telegram-username").value);
  
  if (!description) return showNotification("يرجى ملء الوصف", "error");
  if (contactMethod === "whatsapp" && whatsapp.length !== 12) return showNotification("رقم واتساب غير صالح", "error");
  if (contactMethod === "telegram" && !telegram) return showNotification("معرّف تلكرام غير صالح", "error");
  
  createPostBusy = true;
  const btn = document.getElementById("post-submit-btn");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري النشر...';
  
  try {
    const formattedPrice = formatPriceWithZeros(price);
    const formattedCheapestPrice = formatPriceWithZeros(cheapestPrice);
    
    const newPost = {
      userId: currentUser.uid,
      userName: currentUser.name,
      userEmail: currentUser.email || "",
      stage, material, 
      price: Number(formattedPrice) || 0, 
      cheapestPrice: Number(formattedCheapestPrice) || 0,
      description, contactMethod,
      whatsapp: contactMethod === "whatsapp" ? whatsapp : "",
      telegram: contactMethod === "telegram" ? telegram : "",
      status: "active",
      isPinned: false,
      commentsCount: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection("posts").add(newPost);
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    closeCreatePostModal();
    await loadPostsFromFirestore();
    showNotification("تم نشر المنشور بنجاح");
  } catch (err) {
    showNotification("حدث خطأ أثناء النشر: " + (err.message || err), "error");
  } finally {
    createPostBusy = false;
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function openEditPostModal(postId) {
  const post = posts.find(p => p.id === postId);
  if (!post) return showNotification("لم يتم العثور على المنشور", "error");
  
  document.getElementById('edit-post-id').value = postId;
  document.getElementById('edit-post-stage').value = post.stage || 'sades-elmi';
  document.getElementById('edit-post-price').value = post.price || 0;
  document.getElementById('edit-post-cheapest-price').value = post.cheapestPrice || 0;
  document.getElementById('edit-post-material').value = post.material || 'اسلامية';
  document.getElementById('edit-post-description').value = post.description || '';
  document.getElementById('edit-contact-method').value = post.contactMethod || 'whatsapp';
  document.getElementById('edit-whatsapp-number').value = post.whatsapp || '';
  document.getElementById('edit-telegram-username').value = post.telegram || '';
  changeContactMethod('edit');
  document.getElementById('edit-post-modal').style.display = 'block';
}

function closeEditPostModal() {
  document.getElementById('edit-post-modal').style.display = 'none';
}

async function savePostEdits() {
  const postId = document.getElementById('edit-post-id').value;
  if (!postId) return;
  
  const price = document.getElementById('edit-post-price').value.trim();
  const cheapestPrice = document.getElementById('edit-post-cheapest-price').value.trim();
  const formattedPrice = formatPriceWithZeros(price);
  const formattedCheapestPrice = formatPriceWithZeros(cheapestPrice);
  
  const updatedData = {
    stage: document.getElementById('edit-post-stage').value.trim(),
    price: Number(formattedPrice) || 0,
    cheapestPrice: Number(formattedCheapestPrice) || 0,
    material: document.getElementById('edit-post-material').value,
    description: document.getElementById('edit-post-description').value.trim(),
    contactMethod: document.getElementById('edit-contact-method').value,
    whatsapp: formatWhatsApp(document.getElementById('edit-whatsapp-number').value),
    telegram: sanitizeTelegram(document.getElementById('edit-telegram-username').value),
  };
  
  if (!updatedData.description) return showNotification("الوصف مطلوب", "error");
  if (updatedData.contactMethod === "whatsapp" && updatedData.whatsapp.length !== 12) return showNotification("رقم واتساب غير صالح", "error");
  if (updatedData.contactMethod === "telegram" && !updatedData.telegram) return showNotification("معرّف تلكرام غير صالح", "error");
  
  const btn = document.getElementById('post-edit-submit-btn');
  btn.disabled = true;
  
  try {
    await db.collection('posts').doc(postId).update(updatedData);
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification('تم حفظ التعديلات');
    closeEditPostModal();
    await loadPostsFromFirestore();
    if (pages.userPosts && pages.userPosts.style.display === 'block') { showUserPosts(); }
  } catch (e) {
    showNotification('فشل حفظ التعديلات: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
  }
}

async function showUserPosts() {
  if (!currentUser) return showNotification("يرجى تسجيل الدخول", "warning");
  showPage("userPosts");
  markPostsAsSeen();
  
  if (!window.userPostsContainer) return;
  window.userPostsContainer.innerHTML = "";
  const mine = posts.filter(p => p.userId === currentUser.uid).sort((a, b) => (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0));
  
  if (mine.length === 0) {
    window.userPostsContainer.innerHTML = '<div class="post"><p>لا توجد منشورات لك</p></div>';
    return;
  }
  
  for (const post of mine) {
    const meta = await getUserMeta(post.userId);
    const div = document.createElement("div");
    div.className = `post ${post.status === 'sold' ? 'sold' : ''} ${post.status === 'deleted' ? 'deleted' : ''} ${post.isPinned ? 'pinned' : ''}`;
    
    let actions = '';
    if (post.userId === currentUser.uid) {
      actions = `
        <div class="post-actions">
          <button class="btn btn-xs" onclick="openEditPostModal('${post.id}')"><i class="fas fa-edit"></i> تعديل</button>
          <button class="btn btn-warning btn-xs" onclick="markSoldWithConfirmation('${post.id}', ${post.status === 'sold'})">
            <i class="fas fa-tag"></i> ${post.status === 'sold' ? 'إلغاء البيع' : 'تم البيع'}
          </button>
          <button class="btn btn-success btn-xs" onclick="repost('${post.id}')"><i class="fas fa-sync"></i> إعادة نشر</button>
          <button class="btn btn-danger btn-xs" onclick="deletePostWithConfirmation('${post.id}')"><i class="fas fa-trash"></i> حذف</button>
        </div>
      `;
    }
    
    let userAvatarHtml = '';
    if (meta.avatarBase64) {
      userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
      const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
      const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
      userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
    }
    
    div.innerHTML = `
      <div class="post-header">
        <div class="user-info">
          <div class="rank-avatar-container">
            ${userAvatarHtml}
          </div>
          <div class="user-details">
            <div class="user-name">
              ${escapeHTML(post.userName || 'مستخدم')}
              ${meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : ''}
            </div>
            <div class="post-time">${formatRelativeTime(post.createdAt)}</div>
          </div>
        </div>
      </div>
      
      <div class="post-content">
        <div class="post-meta">
          <span class="post-stage">${stageLabel(post.stage)}</span>
          <span class="post-material">${escapeHTML(post.material || '')}</span>
          <span class="post-price">${priceLabelFromNumber(post.price)}</span>
        </div>
        
        <div class="post-description">
          ${escapeHTML(post.description || '')}
        </div>
      </div>
      
      ${actions}
    `;
    
    window.userPostsContainer.appendChild(div);
  }
}

function updatePostCountInProfile() {
  if (!currentUser) return;
  const count = posts.filter(p => p.userId === currentUser?.uid && p.status !== 'deleted').length;
  const el = document.getElementById("profile-count");
  if (el) el.textContent = `عدد منشوراتك: ${count}`;
}

async function repost(postId) {
  const doc = await db.collection("posts").doc(postId).get();
  if (!doc.exists || doc.data().userId !== currentUser.uid) return;
  await db.collection("posts").doc(postId).update({
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'active'
  });
  
  const cacheKey = 'posts_cache';
  localStorage.removeItem(cacheKey);
  
  showNotification("تم إعادة النشر وتحديث التاريخ");
  await loadPostsFromFirestore();
  showUserPosts();
}

async function markSold(postId, isSold) {
  const doc = await db.collection("posts").doc(postId).get();
  if (!doc.exists || doc.data().userId !== currentUser.uid) return;
  await db.collection("posts").doc(postId).update({
    status: isSold ? 'active' : 'sold'
  });
  
  const cacheKey = 'posts_cache';
  localStorage.removeItem(cacheKey);
  
  showNotification(isSold ? "تم إلغاء حالة البيع" : "تم تحديد: تم بيعه");
  await loadPostsFromFirestore();
  showUserPosts();
}

async function deletePost(postId) {
  if (!currentUser || !confirm("هل أنت متأكد من حذف هذا المنشور؟")) return;
  
  try {
    const doc = await db.collection("posts").doc(postId).get();
    if (!doc.exists || doc.data().userId !== currentUser.uid) return showNotification("غير مسموح", "error");
    
    try {
      await db.collection("posts").doc(postId).delete();
    } catch (delErr) {
      await db.collection("posts").doc(postId).update({ status: 'deleted' });
    }
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification("تم الحذف");
    await loadPostsFromFirestore();
    await showUserPosts();
  } catch (err) {
    showNotification("خطأ أثناء الحذف: " + (err.message || err), "error");
  }
}

async function renderDetails(postId) {
  if (!window.detailsContainer) return;
  window.detailsContainer.innerHTML = "<div class='post'><p>جاري التحميل...</p></div>";
  const post = posts.find(p => p.id === postId);
  if (!post) {
    window.detailsContainer.innerHTML = "<div class='post'><p>تعذر تحميل التفاصيل</p></div>";
    return;
  }
  
  const meta = await getUserMeta(post.userId);
  const userDoc = await db.collection("users").doc(post.userId).get();
  const userData = userDoc.data();
  
  const card = document.createElement("div");
  card.className = `post ${post.isPinned ? 'pinned' : ''}`;
  
  let userAvatarHtml = '';
  if (meta.avatarBase64) {
    userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
  }
  
  const userCreatedAt = userData?.createdAt?.toDate ? userData.createdAt.toDate() : null;
  const userJoinTime = userCreatedAt ? formatRelativeTime(userCreatedAt) : 'غير معروف';
  const lastSeen = userData?.lastSeen?.toDate ? formatRelativeTime(userData.lastSeen.toDate()) : 'غير معروف';
  
  card.innerHTML = `
    ${post.isPinned ? '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> مثبت</div>' : ''}
    
    <div class="post-header">
      <div class="user-info">
        <div class="rank-avatar-container">
          ${userAvatarHtml}
        </div>
        <div class="user-details">
          <div class="user-name">
            ${escapeHTML(post.userName || 'مستخدم')}
            ${meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : ''}
          </div>
          <div class="post-time">${formatRelativeTime(post.createdAt)}</div>
        </div>
      </div>
    </div>
    
    <div class="details-info">
      <h3 style="margin-bottom: 15px; color: #4a6bff; text-align: center;">معلومات مفصلة</h3>
      
      <div class="detail-item">
        <span class="detail-label">👤 اسم البائع:</span>
        <span class="detail-value">${escapeHTML(post.userName || 'مستخدم')}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📚 المرحلة:</span>
        <span class="detail-value">${stageLabel(post.stage)}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📖 المادة:</span>
        <span class="detail-value">${escapeHTML(post.material || 'غير محدد')}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">💰 السعر:</span>
        <span class="detail-value">${priceLabelFromNumber(post.price)}</span>
      </div>
      
      ${post.cheapestPrice > 0 ? `
      <div class="detail-item">
        <span class="detail-label">🏷️ أرخص سعر للملزمة:</span>
        <span class="detail-value" style="color: #28a745; font-weight: 900;">${priceLabelFromNumber(post.cheapestPrice)}</span>
      </div>
      ` : ''}
      
      <div class="detail-item">
        <span class="detail-label">🕒 وقت النشر:</span>
        <span class="detail-value">${post.createdAt?.toLocaleString?.('ar-IQ') || 'غير معروف'}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">👀 آخر ظهور للبائع:</span>
        <span class="detail-value">${lastSeen}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📅 انضم منذ:</span>
        <span class="detail-value">${userJoinTime}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📞 طريقة التواصل:</span>
        <span class="detail-value">
          ${post.contactMethod === "whatsapp" ? "واتساب" : 
            post.contactMethod === "telegram" ? "تليجرام" : 
            "التعليقات"}
        </span>
      </div>
    </div>
  `;
  
  window.detailsContainer.innerHTML = '';
  window.detailsContainer.appendChild(card);
}

function openDetailsPage(postId) {
  currentDetailsPostId = postId;
  showPage("details");
  renderDetails(postId);
}

async function reportPost(postId) {
  if (!currentUser) return showNotification('يلزم تسجيل الدخول', 'warning');
  const reason = prompt('سبب الإبلاغ:');
  if (!reason) return;
  
  try {
    const post = posts.find(p => p.id === postId);
    
    const ownerQuery = await db.collection('users')
      .where('email', '==', APP_OWNER_EMAIL)
      .limit(1)
      .get();
    
    if (ownerQuery.empty) return;
    
    const ownerDoc = ownerQuery.docs[0];
    const ownerUid = ownerDoc.id;
    
    await db.collection('inbox').add({
      userId: ownerUid,
      type: 'admin_report',
      postId: postId,
      reporterUid: currentUser.uid,
      reporterName: currentUser.name || 'مستخدم',
      reporterShortUid: currentUser.shortUid || 'غير معروف',
      title: '🚨 بلاغ جديد',
      message: `👤 المبلغ: ${currentUser.name || 'مستخدم'}\nالسبب: ${reason}\n🆔 معرف المبلغ: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
    if (!reportedPosts.includes(postId)) {
      reportedPosts.push(postId);
      localStorage.setItem('reportedPosts', JSON.stringify(reportedPosts));
    }
    
    showNotification('تم الإبلاغ عن المنشور وسيتم مراجعته');
    
  } catch (e) {
    showNotification('تعذّر إرسال البلاغ', 'error');
  }
}

async function openCommentsPage(postId) {
  if (!currentUser) return;
  currentCommentsPostId = postId;
  showPage("comments");
  await renderComments(postId);
}

async function renderCommentsWithCache(postId, forceRefresh = false) {
  const container = document.getElementById("comments-list-page");
  if (!container) return;
  
  try {
    const cacheKey = `comments_${postId}`;
    const cacheTime = `comments_time_${postId}`;
    const now = Date.now();
    const cacheExpiry = 30 * 1000;
    
    let comments = [];
    let fromCache = false;
    
    if (!forceRefresh) {
      const cachedComments = localStorage.getItem(cacheKey);
      const cacheTimestamp = localStorage.getItem(cacheTime);
      
      if (cachedComments && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
        comments = JSON.parse(cachedComments);
        fromCache = true;
        container.innerHTML = renderCommentsHTML(comments);
        
        if (comments.length > 0) {
          container.insertAdjacentHTML('afterbegin', `
            <div class="post" style="background: #f8f9fa; border-left: 4px solid #ffc107; margin-bottom: 10px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-sync-alt fa-spin" style="color: #ffc107;"></i>
                  <small style="color: var(--text-color);">يتم تحديث التعليقات...</small>
                </div>
                <button onclick="refreshComments('${postId}')" class="btn btn-xs" style="padding: 4px 8px;">
                  تحديث الآن
                </button>
              </div>
            </div>
          `);
        }
      }
    }
    
    if (!fromCache || forceRefresh) {
      if (!forceRefresh) {
        container.innerHTML = `
          <div class="post" style="text-align: center; padding: 30px;">
            <div class="spinner" style="width: 30px; height: 30px; border: 3px solid #ddd; border-top: 3px solid #4a6bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
            <p>جاري تحميل التعليقات...</p>
          </div>
        `;
      }
      
      const snap = await db.collection("posts").doc(postId).collection("comments")
        .orderBy("createdAt", "desc")
        .limit(50)
        .get();
      
      if (snap.empty) {
        container.innerHTML = '<div class="post"><p>لا توجد تعليقات بعد.</p></div>';
        localStorage.setItem(cacheKey, JSON.stringify([]));
        localStorage.setItem(cacheTime, now.toString());
        return;
      }
      
      comments = snap.docs.map(doc => ({ 
        id: doc.id, 
        ...doc.data(),
        docRef: doc.ref
      })).reverse();
      
      localStorage.setItem(cacheKey, JSON.stringify(comments));
      localStorage.setItem(cacheTime, now.toString());
      
      startCommentsListener(postId, comments);
      
      container.innerHTML = renderCommentsHTML(comments);
    }
    
    if (fromCache) {
      setTimeout(async () => {
        try {
          const freshSnap = await db.collection("posts").doc(postId).collection("comments")
            .orderBy("createdAt", "desc")
            .limit(50)
            .get();
          
          if (freshSnap.size > comments.length) {
            const freshComments = freshSnap.docs.map(doc => ({ 
              id: doc.id, 
              ...doc.data() 
            })).reverse();
            
            localStorage.setItem(cacheKey, JSON.stringify(freshComments));
            localStorage.setItem(cacheTime, Date.now().toString());
            
            container.innerHTML = renderCommentsHTML(freshComments);
          }
        } catch (e) {
        }
      }, 2000);
    }
    
  } catch (e) {
    container.innerHTML = `
      <div class="post">
        <p>خطأ في تحميل التعليقات.</p>
        <button onclick="renderCommentsWithCache('${postId}', true)" class="btn" style="margin-top: 10px;">
          <i class="fas fa-redo"></i> إعادة المحاولة
        </button>
      </div>
    `;
  }
}

async function refreshComments(postId) {
  await renderCommentsWithCache(postId, true);
}

function startCommentsListener(postId, existingComments = []) {
  if (!postId) return;
  
  try {
    const lastCommentTime = existingComments.length > 0 
      ? existingComments[existingComments.length - 1].createdAt 
      : null;
    
    const unsubscribe = db.collection("posts").doc(postId).collection("comments")
      .orderBy("createdAt", "desc")
      .limit(1)
      .onSnapshot((snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            const newComment = { id: change.doc.id, ...change.doc.data() };
            
            const isDuplicate = existingComments.some(c => c.id === newComment.id);
            
            if (!isDuplicate && (!lastCommentTime || newComment.createdAt?.toDate?.() > lastCommentTime?.toDate?.())) {
              const cacheKey = `comments_${postId}`;
              const cachedComments = JSON.parse(localStorage.getItem(cacheKey) || '[]');
              cachedComments.push(newComment);
              localStorage.setItem(cacheKey, JSON.stringify(cachedComments));
              localStorage.setItem(`comments_time_${postId}`, Date.now().toString());
              
              const container = document.getElementById("comments-list-page");
              if (container && window.location.hash.includes('comments-page')) {
                container.innerHTML = renderCommentsHTML(cachedComments);
              }
            }
          }
        });
      }, (error) => {
      });
    
    window.currentCommentsListener = unsubscribe;
    
  } catch (error) {
  }
}

function renderCommentsHTML(comments) {
  const userIds = [...new Set(comments.map(c => c.userId).filter(Boolean))];
  
  Promise.all(userIds.map(async uid => {
    if (!userMetaCache[uid]) {
      userMetaCache[uid] = await getUserMeta(uid);
    }
  })).then(() => {});
  
  return comments.map(comment => {
    const meta = userMetaCache[comment.userId] || { isVerified: false, avatar: 'male', avatarBase64: null };
    const time = comment.createdAt?.toDate ? formatRelativeTime(comment.createdAt.toDate()) : '';
    
    let userAvatarHtml = '';
    if (meta.avatarBase64) {
      userAvatarHtml = `<img src="${meta.avatarBase64}" class="comment-avatar">`;
    } else {
      const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
      const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
      userAvatarHtml = `<div class="comment-avatar" style="background:${avatarBackground}; display:flex; align-items:center; justify-content:center; font-size:16px;">${userAvatar}</div>`;
    }
    
    return `
      <div class="comment">
        <div class="comment-header">
          ${userAvatarHtml}
          <div>
            <div class="comment-user">
              ${escapeHTML(comment.userName || 'مستخدم')}
              ${meta.isVerified ? `<span class="badge-verified" style="padding: 2px 6px; font-size: 10px;"><i class="fa-solid fa-crown"></i></span>` : ''}
            </div>
            <div class="comment-time">${time}</div>
          </div>
        </div>
        <div class="comment-content">${escapeHTML(comment.text || '')}</div>
        <div class="comment-actions">
          <button class="comment-action" onclick="replyToComment('${comment.userId}', '${comment.userName}')">
            <i class="fas fa-reply"></i> رد
          </button>
          ${comment.userId === currentUser.uid ? `
          <button class="comment-action" onclick="deleteCommentWithConfirmation('${comment.id}', '${currentCommentsPostId}')">
            <i class="fas fa-trash"></i> حذف
          </button>
          ` : ''}
          ${isOwner() || (currentUser && currentUser.uid === posts.find(p => p.id === currentCommentsPostId)?.userId) ? `
          <button class="comment-action" onclick="banCommentUserWithConfirmation('${comment.userId}', '${currentCommentsPostId}')">
            <i class="fas fa-ban"></i> حظر
          </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

async function addCommentFromPage() {
  if (!currentUser || !currentCommentsPostId) return;
  const textInput = document.getElementById("comment-text-page");
  const text = textInput.value.trim();
  if (!text) return;
  
  const btn = document.getElementById('send-comment-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  
  try {
    const commentRef = await db.collection("posts").doc(currentCommentsPostId).collection("comments").add({
      text, 
      userId: currentUser.uid, 
      userName: currentUser.name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    const postRef = db.collection("posts").doc(currentCommentsPostId);
    await postRef.update({
      commentsCount: firebase.firestore.FieldValue.increment(1)
    });
    
    const postIndex = posts.findIndex(p => p.id === currentCommentsPostId);
    if (postIndex !== -1) {
      posts[postIndex].commentsCount = (posts[postIndex].commentsCount || 0) + 1;
    }
    
    const post = posts.find(p => p.id === currentCommentsPostId);
    
    if (post && post.userId !== currentUser.uid && !isOwner()) {
      await db.collection('inbox').add({
        userId: post.userId,
        type: 'comment_notification',
        title: '💬 تعليق جديد',
        message: `تعليق جديد على منشورك من ${currentUser.name}: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`,
        postId: currentCommentsPostId,
        commentId: commentRef.id,
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    await sendCommentReplyNotifications(currentCommentsPostId, text, currentUser.name);
    
    textInput.value = '';
    
    await renderCommentsWithCache(currentCommentsPostId);
    
    showNotification('تم إرسال التعليق');
    
  } catch (e) {
    showNotification('تم إرسال التعليق بنجاح');
    textInput.value = '';
    await renderCommentsWithCache(currentCommentsPostId);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'إرسال';
  }
}

async function sendCommentReplyNotifications(postId, commentText, commenterName) {
  try {
    const cacheKey = `post_comments_${postId}`;
    const cacheTime = `post_comments_time_${postId}`;
    const now = Date.now();
    const cacheExpiry = 5 * 60 * 1000;
    
    let commentsSnap;
    const cachedComments = localStorage.getItem(cacheKey);
    const cacheTimestamp = localStorage.getItem(cacheTime);
    
    if (cachedComments && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
      commentsSnap = { 
        forEach: (callback) => JSON.parse(cachedComments).forEach(callback) 
      };
    } else {
      commentsSnap = await db.collection("posts").doc(postId).collection("comments").get();
      const commentsData = [];
      commentsSnap.forEach(doc => {
        commentsData.push({ id: doc.id, ...doc.data() });
      });
      localStorage.setItem(cacheKey, JSON.stringify(commentsData));
      localStorage.setItem(cacheTime, now.toString());
    }
    
    const mentionedUsers = new Set();
    
    commentsSnap.forEach(doc => {
      const comment = doc.data ? doc.data() : doc;
      if (comment.userName && commentText.includes(`@${comment.userName}`) && comment.userId !== currentUser.uid) {
        mentionedUsers.add(comment.userId);
      }
    });
    
    let ownerUid = null;
    try {
      const ownerQuery = await db.collection('users')
        .where('email', '==', APP_OWNER_EMAIL)
        .limit(1)
        .get();
      
      if (!ownerQuery.empty) {
        ownerUid = ownerQuery.docs[0].id;
      }
    } catch (error) {
    }
    
    const batch = db.batch();
    let notificationCount = 0;
    
    for (const userId of mentionedUsers) {
      if (ownerUid && userId === ownerUid) {
        continue;
      }
      
      if (notificationCount >= 10) break;
      
      const notificationRef = db.collection('inbox').doc();
      batch.set(notificationRef, {
        userId: userId,
        type: 'comment_reply',
        title: '💬 رد على تعليقك',
        message: `قام ${commenterName} بالرد على تعليقك: ${commentText.substring(0, 50)}${commentText.length > 50 ? '...' : ''}`,
        postId: postId,
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      notificationCount++;
    }
    
    if (notificationCount > 0) {
      await batch.commit();
    }
    
  } catch (error) {
  }
}

function replyToComment(userId, userName) {
  const textInput = document.getElementById("comment-text-page");
  textInput.value = `@${userName} `;
  textInput.focus();
}

async function deleteComment(commentId, postId) {
  if (!currentUser) return;
  
  if (!confirm('هل أنت متأكد من حذف هذا التعليق؟')) return;
  
  try {
    await db.collection("posts").doc(postId).collection("comments").doc(commentId).delete();
    
    const postRef = db.collection("posts").doc(postId);
    const postDoc = await postRef.get();
    const currentCount = postDoc.data().commentsCount || 0;
    if (currentCount > 0) {
      await postRef.update({
        commentsCount: currentCount - 1
      });
    }
    
    const postIndex = posts.findIndex(p => p.id === postId);
    if (postIndex !== -1 && posts[postIndex].commentsCount > 0) {
      posts[postIndex].commentsCount--;
    }
    
    showNotification('تم حذف التعليق');
    await renderComments(postId);
    
  } catch (error) {
    showNotification('فشل حذف التعليق', 'error');
  }
}

async function banCommentUser(userId, postId) {
  if (!currentUser) return;
  
  const post = posts.find(p => p.id === postId);
  if (!post || (post.userId !== currentUser.uid && !isOwner())) {
    return showNotification('غير مسموح', 'error');
  }
  
  if (!confirm('هل أنت متأكد من حظر هذا المستخدم من التعليق على منشوراتك؟')) return;
  
  try {
    await db.collection('userBlocks').add({
      blockerId: currentUser.uid,
      blockedUserId: userId,
      postId: postId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('تم حظر المستخدم من التعليق على منشوراتك');
    
  } catch (error) {
    showNotification('فشل حظر المستخدم', 'error');
  }
}

async function renderComments(postId) {
  await renderCommentsWithCache(postId);
}

async function ownerTogglePin(postId, isPinned) {
  if (!isOwner()) return;
  try {
    await db.collection('posts').doc(postId).update({ isPinned: !isPinned });
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification(isPinned ? 'أُلغي التثبيت' : 'تم التثبيت');
    await loadPostsFromFirestore();
  } catch (e) {
    showNotification('فشل العملية', 'error');
  }
}

async function ownerToggleVerify(uid) {
  if (!isOwner()) return;
  try {
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.isVerified;
    await uref.update({ isVerified: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid] || {}), isVerified: !cur };
    showNotification(!cur ? 'تم توثيق المستخدم' : 'أُلغي التوثيق');
    await renderPosts();
  } catch (e) {
    showNotification('فشل العملية', 'error');
  }
}

async function ownerToggleUserBanById(uid) {
  if (!isOwner()) return;
  try {
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.blockedFromPosting;
    await uref.update({ blockedFromPosting: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid] || {}), blockedFromPosting: !cur };
    showNotification(!cur ? 'تم حظر المستخدم من النشر' : 'تم إلغاء الحظر');
  } catch (e) {
    showNotification('فشل العملية', 'error');
  }
}

async function ownerDeletePost(postId) {
  if (!isOwner()) return;
  if (!confirm('حذف المنشور نهائيًا؟')) return;
  try {
    await db.collection('posts').doc(postId).delete();
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification('حُذف المنشور');
    await loadPostsFromFirestore();
  } catch (e) {
    showNotification('فشل الحذف', 'error');
  }
}

const GOVERNORATES = ["بغداد", "نينوى", "البصرة", "أربيل", "النجف", "كربلاء", "ذي قار", "السليمانية", "ديالى", "الأنبار", "بابل", "كركوك", "واسط", "المثنى", "القادسية", "ميسان", "صلاح الدين", "دهوك", "كل المحافظات"];

function populateGovernorateSelects(selectId) {
  const select = document.getElementById(selectId);
  if (!select?.dataset?.populated) {
    select.innerHTML = GOVERNORATES.map(g => `<option value="${g}">${g}</option>`).join('');
    if (select) select.dataset.populated = "true";
  }
}

function openCreateCompanyModal() {
  if (!isOwner()) return showNotification('للمالك فقط', 'error');
  populateGovernorateSelects('company-from');
  populateGovernorateSelects('company-to');
  document.getElementById('create-company-modal').style.display = 'block';
}

function closeCreateCompanyModal() {
  document.getElementById('create-company-modal').style.display = 'none';
}

async function createCompany() {
  if (!isOwner()) return;
  const data = {
    name: document.getElementById('company-name').value.trim(),
    from: document.getElementById('company-from').value,
    to: document.getElementById('company-to').value,
    phone: document.getElementById('company-phone').value.trim(),
    desc: document.getElementById('company-desc').value.trim(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  if (!data.name || !data.phone || !data.from || !data.to) {
    return showNotification("يرجى ملء جميع الحقول المطلوبة", "error");
  }
  
  const btn = document.getElementById('company-submit-btn');
  btn.disabled = true;
  
  try {
    await db.collection('companies').add(data);
    showNotification("تمت إضافة الشركة");
    closeCreateCompanyModal();
    await loadCompanies();
  } catch (e) {
    showNotification("فشل إضافة الشركة: " + e.message, "error");
  } finally {
    btn.disabled = false;
  }
}

async function loadCompanies() {
  try {
    const snap = await db.collection('companies').orderBy('createdAt', 'desc').get();
    companies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderCompanies();
  } catch (e) {
    if (window.companiesContainer) {
      window.companiesContainer.innerHTML = '<div class="post"><p>خطأ تحميل الشركات</p></div>';
    }
  }
}

function renderCompanies() {
  if (!window.companiesContainer) return;
  if (!companies || companies.length === 0) {
    window.companiesContainer.innerHTML = '<div class="post"><p>لا توجد شركات بعد</p></div>';
    return;
  }
  
  window.companiesContainer.innerHTML = companies.map(c => `
    <div class="company">
      <div class="name"><i class="fa-solid fa-truck"></i> ${escapeHTML(c.name || 'شركة')}</div>
      <div class="route">من: ${escapeHTML(c.from || '-')} → إلى: ${escapeHTML(c.to || '-')}</div>
      <div class="phone"><i class="fa-solid fa-phone"></i> ${escapeHTML(c.phone || '')}</div>
      ${c.desc ? `<div class="desc">${escapeHTML(c.desc)}</div>` : ''}
      ${isOwner() ? `<div class="post-actions" style="margin-top:8px">
        <button class="btn btn-danger btn-xs" onclick="deleteCompany('${c.id}')"><i class="fa-solid fa-trash"></i> حذف</button>
      </div>` : ''}
    </div>
  `).join('');
}

async function deleteCompany(id) {
  if (!isOwner()) return;
  if (!confirm('حذف الشركة؟')) return;
  try {
    await db.collection('companies').doc(id).delete();
    showNotification('حُذفت الشركة');
    await loadCompanies();
  } catch (e) {
    showNotification('فشل الحذف', 'error');
  }
}

async function setAvatar(kind) {
  if (!currentUser) return;
  try {
    await db.collection('users').doc(currentUser.uid).update({ 
      avatar: kind,
      avatarBase64: null
    });
    currentUser.avatar = kind;
    currentUser.avatarBase64 = null;
    updateAvatarDisplay();
    showNotification('تم تحديث الصورة');
    closeAvatarModal();
  } catch {
    showNotification('فشل تحديث الصورة', 'error');
  }
}

function renderAvatarPreview() {
  const previewElement = document.getElementById('current-avatar-preview');
  if (!previewElement) return;
  
  if (currentUser && currentUser.avatarBase64) {
    previewElement.innerHTML = `<img src="${currentUser.avatarBase64}" class="rank-avatar" style="width:80px;height:80px;">`;
  } else {
    const emoji = currentUser?.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    const bg = currentUser?.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    previewElement.innerHTML = `<div style="width:80px;height:80px;border-radius:50%;background:${bg};display:grid;place-items:center;font-size:32px;">${emoji}</div>`;
  }
}

async function editProfileName() {
  if (!currentUser) return;
  const newName = prompt('اكتب الاسم الجديد:', currentUser.name || '');
  if (!newName) return;
  try {
    await db.collection('users').doc(currentUser.uid).update({ name: newName });
    currentUser.name = newName;
    document.getElementById('profile-name').textContent = newName;
    showNotification('تم تغيير الاسم');
  } catch {
    showNotification('فشل تغيير الاسم', 'error');
  }
}

async function showInbox() {
  if (!currentUser) return showNotification('سجّل الدخول', 'warning');
  showPage('inbox');
  
  if (!window.inboxContainer) return;
  
  window.inboxContainer.innerHTML = `
    <div class="post" style="text-align: center; padding: 30px;">
      <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
        <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid #4a6bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <style>
          @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        </style>
        <p style="color: var(--text-color); font-weight: 600;">جاري تحميل الرسائل...</p>
      </div>
    </div>
  `;
  
  try {
    const cacheKey = `inbox_cache_${currentUser.uid}`;
    const cacheTime = `inbox_cache_time_${currentUser.uid}`;
    const now = Date.now();
    const cacheExpiry = 30 * 1000;
    
    let messages = [];
    let fromCache = false;
    
    const cachedMessages = localStorage.getItem(cacheKey);
    const cacheTimestamp = localStorage.getItem(cacheTime);
    
    if (cachedMessages && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
      messages = JSON.parse(cachedMessages);
      fromCache = true;
      renderInboxMessages(messages, fromCache);
    }
    
    let querySnapshot;
    
    if (isOwner()) {
      querySnapshot = await db.collection('inbox')
        .orderBy('createdAt', 'desc')
        .limit(100)
        .get();
      
      messages = querySnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        docRef: doc.ref
      }));
    } else {
      querySnapshot = await db.collection('inbox')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .limit(100)
        .get();
      
      messages = querySnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        docRef: doc.ref
      }));
    }
    
    localStorage.setItem(cacheKey, JSON.stringify(messages));
    localStorage.setItem(cacheTime, now.toString());
    
    if (!fromCache || messages.length > 0) {
      renderInboxMessages(messages, false);
    }
    
    await markAllNotificationsAsRead();
    
  } catch (error) {
    window.inboxContainer.innerHTML = `
      <div class="post" style="text-align: center;">
        <p style="color: #ff6b6b;">خطأ في تحميل الرسائل</p>
        <button onclick="showInbox()" class="btn" style="margin-top: 10px;">
          <i class="fas fa-redo"></i> إعادة المحاولة
        </button>
      </div>
    `;
  }
}

function renderInboxMessages(messages, fromCache = false) {
  if (!window.inboxContainer) return;
  
  if (messages.length === 0) {
    window.inboxContainer.innerHTML = `
      <div class="post" style="text-align: center; padding: 40px 20px;">
        <i class="fas fa-inbox" style="font-size: 48px; color: #999; margin-bottom: 15px;"></i>
        <p style="color: var(--text-color); font-size: 16px;">لا توجد رسائل حالياً</p>
        <p style="color: #999; font-size: 14px; margin-top: 5px;">سيتم عرض الرسائل الجديدة هنا تلقائياً</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  if (fromCache) {
    html += `
      <div class="post" style="background: #f8f9fa; border-left: 4px solid #ffc107; margin-bottom: 10px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-sync-alt fa-spin" style="color: #ffc107;"></i>
          <small style="color: var(--text-color);">يتم تحديث البيانات من الخادم...</small>
        </div>
      </div>
    `;
  }
  
  messages.forEach(msg => {
    const created = msg.createdAt?.toDate ? formatRelativeTime(msg.createdAt.toDate()) : '';
    const isUnread = msg.status === 'unread';
    const isResolved = msg.status === 'resolved';
    
    if (msg.type === 'comment_reply' || msg.type === 'comment_notification') {
      const postId = msg.postId || '';
      const isCommentReply = msg.type === 'comment_reply';
      
      html += `
        <div class="post" style="border-right: ${isUnread ? '4px solid #4a6bff' : 'none'}; background: ${isUnread ? '#f8f9fa' : '#fff'}; cursor: pointer;" 
             onclick="openCommentsFromNotification('${postId}', '${msg.id}')">
          <div style="font-weight:bold;color:#0f235f; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-comment${isCommentReply ? '-dots' : ''}"></i>
            ${escapeHTML(msg.title || (isCommentReply ? 'رد على تعليقك' : 'تعليق جديد'))}
            ${isUnread ? '<span style="background: #4a6bff; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 5px;">جديد</span>' : ''}
          </div>
          <p style="margin-top:8px; white-space: pre-wrap;">${escapeHTML(msg.message || '')}</p>
          <div style="margin-top: 8px; color: #4a6bff; font-weight: 600; font-size: 13px;">
            <i class="fas fa-external-link-alt"></i> انقر لفتح التعليقات
          </div>
          <small style="color:#777">${created}</small>
        </div>`;
    }
    else if (isOwner() && (msg.type === 'admin_report' || msg.type === 'support_request')) {
      if (isResolved) {
        html += `
          <div class="post" style="opacity:0.7; background:#f8f9fa; border-right: ${isUnread ? '4px solid #4a6bff' : 'none'};">
            <div style="font-weight:bold;color:#0f235f">📩 ${msg.type === 'support_request' ? 'طلب دعم' : 'بلاغ'} - ${msg.actionMessage || 'تم المعالجة'}</div>
            <p style="margin-top:8px; white-space: pre-wrap;">${escapeHTML(msg.message || '')}</p>
            <div style="color:#28a745; font-weight:bold; margin-top:8px;">
              ✅ ${msg.actionMessage || 'تمت المعالجة'}
            </div>
            <small style="color:#777">${created}</small>
          </div>`;
      } else {
        const typeText = msg.supportType === 'problem' ? 'مشكلة' : msg.supportType === 'suggestion' ? 'اقتراح' : 'طلب دعم';
        const typeIcon = msg.supportType === 'problem' ? '🚨' : msg.supportType === 'suggestion' ? '💡' : '📩';
        
        html += `
          <div class="post" style="border-right: ${isUnread ? '4px solid #4a6bff' : 'none'}; background: ${isUnread ? '#f8f9fa' : '#fff'};">
            <div style="font-weight:bold;color:#0f235f">${typeIcon} ${typeText} ${isUnread ? '<span style="background: #4a6bff; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 5px;">جديد</span>' : ''}</div>
            <p style="margin-top:8px; white-space: pre-wrap;">${escapeHTML(msg.message || '')}</p>
            ${msg.type === 'admin_report' ? `
            <div class="post-actions" style="margin-top: 12px; display: flex; gap: 6px; flex-wrap: wrap;">
              <button class="btn btn-danger btn-xs" onclick="adminReportAction('${msg.id}','ban_poster','${escapeHTML(msg.postOwnerId || '')}')">
                <i class="fa-solid fa-ban"></i> حظر
              </button>
              <button class="btn btn-warning btn-xs" onclick="adminReportAction('${msg.id}','delete_post','${escapeHTML(msg.postId || '')}')">
                <i class="fa-solid fa-trash"></i> حذف
              </button>
              <button class="btn btn-success btn-xs" onclick="adminReportAction('${msg.id}','view_single_post','${escapeHTML(msg.postOwnerId || '')}','','${escapeHTML(msg.postId || '')}')">
                <i class="fa-solid fa-eye"></i> عرض
              </button>
              <button class="btn btn-secondary btn-xs" onclick="adminReportAction('${msg.id}','reject','')">
                <i class="fa-solid fa-x"></i> رفض
              </button>
            </div>
            ` : ''}
            <small style="color:#777">${created}</small>
          </div>`;
      }
    }
    else {
      html += `
        <div class="post" style="border-right: ${isUnread ? '4px solid #4a6bff' : 'none'}; background: ${isUnread ? '#f8f9fa' : '#fff'};">
          <div style="font-weight:bold;color:#0f235f">${escapeHTML(msg.title || 'إشعار')} ${isUnread ? '<span style="background: #4a6bff; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 5px;">جديد</span>' : ''}</div>
          <p style="margin-top:8px; white-space: pre-wrap;">${escapeHTML(msg.message || '')}</p>
          <small style="color:#777">${created}</small>
        </div>`;
    }
  });
  
  window.inboxContainer.innerHTML = html;
  
  if (!fromCache) {
    startInboxListener();
  }
}

async function adminReportAction(inboxDocId, action, targetId, reporterId = '', postId = '') {
  if (!isOwner()) return;
  
  try {
    let actionMessage = '';

    if (action === 'ban_poster' && targetId) {
      await db.collection('users').doc(targetId).update({
        blockedFromPosting: true
      });
      actionMessage = 'تم حظر صاحب المنشور';
    } else if (action === 'ban_reporter' && reporterId) {
      await db.collection('users').doc(reporterId).update({
        blockedFromPosting: true
      });
      actionMessage = 'تم حظر المُبلّغ';
    } else if (action === 'delete_post' && targetId) {
      try {
        await db.collection('posts').doc(targetId).delete();
      } catch (deleteError) {
        await db.collection('posts').doc(targetId).update({
          status: 'deleted'
        });
      }
      actionMessage = 'تم حذف المنشور';
    } else if (action === 'reject') {
      actionMessage = 'تم رفض البلاغ';
    } else if (action === 'view_posts' && targetId) {
      await showUserPostsPage(targetId);
      return;
    } else if (action === 'view_single_post' && postId) {
      await showSinglePostModal(postId);
      return;
    }

    await db.collection('inbox').doc(inboxDocId).update({
      status: 'resolved',
      resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
      resolvedBy: currentUser.uid,
      actionMessage: actionMessage
    });

    showNotification('تم معالجة الإبلاغ بنجاح');
    setTimeout(() => { showInbox(); }, 2000);

  } catch (e) {
    showNotification('فشل تنفيذ الإجراء: ' + e.message, 'error');
  }
}

async function showUserPostsPage(userId) {
  try {
    const userPosts = await db.collection('posts')
      .where('userId', '==', userId)
      .orderBy('createdAt', 'desc')
      .get();
    
    if (userPosts.empty) {
      showNotification('لا توجد منشورات لهذا المستخدم', 'info');
      return;
    }
    
    const postsHTML = `
      <div id="user-posts-page" class="container page" style="display:block">
        <div class="header">
          <button class="btn btn-secondary" onclick="backToInbox()">
            <i class="fas fa-arrow-right"></i>
          </button>
          <span style="font-weight:900">منشورات المستخدم</span>
          <div class="post-actions">
            <button class="btn btn-danger btn-xs" onclick="banUserFromPostsPage('${userId}')">
              <i class="fas fa-ban"></i> حظر المستخدم
            </button>
            <button class="btn btn-warning btn-xs" onclick="deleteAllUserPosts('${userId}')">
              <i class="fas fa-trash"></i> حذف جميع المنشورات
            </button>
          </div>
        </div>
        <div class="posts-container" id="user-posts-admin-container">
          ${userPosts.docs.map(doc => {
            const post = doc.data();
            return `
              <div class="post">
                <div class="post-header">
                  <div class="user-info">
                    <div class="user-details">
                      <div class="user-name">${escapeHTML(post.userName || 'مستخدم')}</div>
                      <div class="post-time">${post.createdAt?.toDate?.().toLocaleString('ar-IQ') || ''}</div>
                    </div>
                  </div>
                </div>
                <div class="post-content">
                  <div class="post-meta">
                    <span class="post-stage">${stageLabel(post.stage)}</span>
                    <span class="post-material">${escapeHTML(post.material || '')}</span>
                    <span class="post-price">${priceLabelFromNumber(post.price)}</span>
                  </div>
                  <div class="post-description">${escapeHTML(post.description || '')}</div>
                </div>
                <div class="post-actions">
                  <button class="btn btn-danger btn-xs" onclick="deleteSinglePost('${doc.id}')">
                    <i class="fas fa-trash"></i> حذف هذا المنشور
                  </button>
                  <button class="btn btn-warning btn-xs" onclick="viewPostDetails('${doc.id}')">
                    <i class="fas fa-eye"></i> عرض التفاصيل
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
    
    document.querySelector('.page[style*="display: block"]').style.display = 'none';
    document.body.insertAdjacentHTML('beforeend', postsHTML);
    
  } catch (error) {
    showNotification('فشل تحميل منشورات المستخدم', 'error');
  }
}

async function showSinglePostModal(postId) {
  try {
    const postDoc = await db.collection('posts').doc(postId).get();
    if (!postDoc.exists) {
      showNotification('المنشور غير موجود', 'error');
      return;
    }
    
    const post = postDoc.data();
    const userDoc = await db.collection('users').doc(post.userId).get();
    const userData = userDoc.data();
    
    const modalHTML = `
      <div id="single-post-modal" class="modal" style="display: block;">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <div class="modal-header">
            <h2>عرض المنشور المبلغ عنه</h2>
            <button class="close-modal" onclick="closeSinglePostModal()">&times;</button>
          </div>
          
          <div class="post">
            <div class="post-header">
              <div class="user-info">
                <div class="user-details">
                  <div class="user-name">
                    ${escapeHTML(post.userName || 'مستخدم')}
                    ${userData?.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : ''}
                  </div>
                  <div class="post-time">${post.createdAt?.toDate?.().toLocaleString('ar-IQ') || ''}</div>
                </div>
              </div>
            </div>
            
            <div class="post-content">
              <div class="post-meta">
                <span class="post-stage">${stageLabel(post.stage)}</span>
                <span class="post-material">${escapeHTML(post.material || '')}</span>
                <span class="post-price">${priceLabelFromNumber(post.price)}</span>
              </div>
              
              <div class="post-description">${escapeHTML(post.description || '')}</div>
              
              <div class="details-info">
                <h4>معلومات الاتصال:</h4>
                <div class="detail-item">
                  <span class="detail-label">طريقة التواصل:</span>
                  <span class="detail-value">${post.contactMethod === "whatsapp" ? "واتساب" : post.contactMethod === "telegram" ? "تليجرام" : "التعليقات"}</span>
                </div>
                ${post.whatsapp ? `
                <div class="detail-item">
                  <span class="detail-label">رقم الواتساب:</span>
                  <span class="detail-value">${post.whatsapp}</span>
                </div>
                ` : ''}
                ${post.telegram ? `
                <div class="detail-item">
                  <span class="detail-label">اسم المستخدم في التليجرام:</span>
                  <span class="detail-value">${post.telegram}</span>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
          
          <div class="modal-footer" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn btn-danger" onclick="banUserFromModal('${post.userId}')">
              <i class="fas fa-ban"></i> حظر صاحب المنشور
            </button>
            <button class="btn btn-warning" onclick="deletePostFromModal('${postId}')">
              <i class="fas fa-trash"></i> حذف المنشور
            </button>
            <button class="btn btn-secondary" onclick="closeSinglePostModal()">
              <i class="fas fa-times"></i> إغلاق
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
  } catch (error) {
    showNotification('فشل تحميل المنشور', 'error');
  }
}

function closeSinglePostModal() {
  const modal = document.getElementById('single-post-modal');
  if (modal) modal.remove();
}

async function banUserFromModal(userId) {
  if (!confirm('هل أنت متأكد من حظر هذا المستخدم؟')) return;
  
  try {
    await db.collection('users').doc(userId).update({
      blockedFromPosting: true
    });
    showNotification('تم حظر المستخدم بنجاح');
    closeSinglePostModal();
  } catch (error) {
    showNotification('فشل حظر المستخدم', 'error');
  }
}

async function deletePostFromModal(postId) {
  if (!confirm('هل أنت متأكد من حذف هذا المنشور؟')) return;
  
  try {
    await db.collection('posts').doc(postId).delete();
    showNotification('تم حذف المنشور بنجاح');
    closeSinglePostModal();
  } catch (error) {
    showNotification('فشل حذف المنشور', 'error');
  }
}

function backToInbox() {
  document.getElementById('user-posts-page').remove();
  showInbox();
}

async function banUserFromPostsPage(userId) {
  if (!confirm('هل أنت متأكد من حظر هذا المستخدم؟')) return;
  
  try {
    await db.collection('users').doc(userId).update({
      blockedFromPosting: true
    });
    showNotification('تم حظر المستخدم بنجاح');
  } catch (error) {
    showNotification('فشل حظر المستخدم', 'error');
  }
}

async function deleteAllUserPosts(userId) {
  if (!confirm('هل أنت متأكد من حذف جميع منشورات هذا المستخدم؟')) return;
  
  try {
    const userPosts = await db.collection('posts')
      .where('userId', '==', userId)
      .get();
    
    const batch = db.batch();
    userPosts.forEach(doc => {
      batch.delete(doc.ref);
    });
    
    await batch.commit();
    showNotification('تم حذف جميع منشورات المستخدم');
    backToInbox();
  } catch (error) {
    showNotification('فشل حذف المنشورات', 'error');
  }
}

async function deleteSinglePost(postId) {
  if (!confirm('هل أنت متأكد من حذف هذا المنشور؟')) return;
  
  try {
    await db.collection('posts').doc(postId).delete();
    showNotification('تم حذف المنشور بنجاح');
    const userId = document.querySelector('#user-posts-page .btn-danger').onclick.toString().match(/'([^']+)'/)[1];
    document.getElementById('user-posts-page').remove();
    await showUserPostsPage(userId);
  } catch (error) {
    showNotification('فشل حذف المنشور', 'error');
  }
}

async function viewPostDetails(postId) {
  await showSinglePostModal(postId);
}

async function fetchLatestBroadcast() {
  if (isFirstLoginSession) return;
  try {
    const seenBroadcasts = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    const userSignupTime = localStorage.getItem('userSignupTime');
    const snap = await db.collection('broadcasts').orderBy('createdAt', 'desc').limit(1).get();
    if (snap.empty) return;
    const broadcast = snap.docs[0];
    const id = broadcast.id;
    const data = broadcast.data();
    const time = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
    if (!seenBroadcasts.includes(id) && (!userSignupTime || new Date(userSignupTime) < time)) {
      document.getElementById('broadcast-title-display').textContent = data.title || 'إشعار عام';
      document.getElementById('broadcast-text-display').textContent = data.message || data.text || '';
      document.getElementById('broadcast-banner').classList.add('show');
      document.getElementById('broadcast-overlay').classList.add('show');
      lastBroadcast = id;
    }
  } catch (e) { }
}

function dismissBroadcast() {
  document.getElementById('broadcast-banner').classList.remove('show');
  document.getElementById('broadcast-overlay').classList.remove('show');
  if (lastBroadcast) {
    const seen = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    if (!seen.includes(lastBroadcast)) {
      seen.push(lastBroadcast);
      localStorage.setItem('seenBroadcasts', JSON.stringify(seen));
    }
  }
}

function getLastSeenPostsTime() {
  const lastSeen = localStorage.getItem('lastSeenPostsTime');
  const time = lastSeen ? new Date(parseInt(lastSeen)) : new Date(0);
  return time;
}

function updateLastSeenPostsTime() {
  const now = Date.now();
  localStorage.setItem('lastSeenPostsTime', now.toString());
  unreadPostsCount = 0;
  updateNavBadges();
}

function startAllListeners() {
  startInboxListener();
  startPostsListener();
}

function startInboxListener() {
  if (!currentUser) return;
  
  if (notificationsListener) {
    notificationsListener();
  }
  
  let inboxQuery;
  
  if (isOwner()) {
    inboxQuery = db.collection('inbox')
      .where('status', '==', 'unread')
      .where('type', 'in', ['support_request', 'admin_report', 'support_reply']);
  } else {
    inboxQuery = db.collection('inbox')
      .where('userId', '==', currentUser.uid)
      .where('status', '==', 'unread');
  }
  
  notificationsListener = inboxQuery.onSnapshot(async (snapshot) => {
    try {
      let unreadCount = 0;
      const nowTime = Date.now();
      const oneWeekAgo = nowTime - (7 * 24 * 60 * 60 * 1000);
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        const msgTime = msg.createdAt?.toDate?.()?.getTime() || 0;
        
        if (isOwner()) {
          unreadCount++;
        } else if (msgTime > oneWeekAgo) {
          unreadCount++;
        }
      });
      
      const oldCount = unreadNotifications.inbox;
      unreadNotifications.inbox = unreadCount;
      
      if (unreadCount > oldCount) {
        updateAllBadges();
        
        const badge = document.getElementById('inbox-badge');
        if (badge && unreadCount > 0) {
          badge.style.animation = 'none';
          setTimeout(() => {
            badge.style.animation = 'pulse 0.5s 3';
          }, 10);
        }
        
        if (isOwner() && unreadCount > oldCount && oldCount === 0) {
          try {
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
            audio.volume = 0.1;
            audio.play().catch(() => {});
          } catch (e) {}
        }
      }
      
      updateAllBadges();
      
    } catch (error) {
      setTimeout(() => {
        if (currentUser) {
          startInboxListener();
        }
      }, 5000);
    }
  }, (error) => {
    setTimeout(() => {
      if (currentUser) {
        startInboxListener();
      }
    }, 5000);
  });
}

function updateAllBadges() {
  const inboxBadge = document.getElementById('inbox-badge');
  if (inboxBadge) {
    if (unreadNotifications.inbox > 0) {
      inboxBadge.style.display = 'flex';
      inboxBadge.textContent = unreadNotifications.inbox > 9 ? '9+' : unreadNotifications.inbox.toString();
      
      if (isOwner()) {
        inboxBadge.style.background = 'linear-gradient(135deg, #ff3b3b, #ff6b6b)';
        inboxBadge.style.boxShadow = '0 2px 10px rgba(255, 59, 59, 0.5)';
      }
    } else {
      inboxBadge.style.display = 'none';
    }
  }
  
  const postsBadge = document.getElementById('posts-badge');
  if (postsBadge) {
    if (unreadPostsCount > 0) {
      postsBadge.style.display = 'flex';
      postsBadge.textContent = unreadPostsCount > 9 ? '9+' : unreadPostsCount.toString();
    } else {
      postsBadge.style.display = 'none';
    }
  }
  
  const profileBadge = document.getElementById('profile-notification-badge');
  if (profileBadge) {
    const totalNotifications = unreadNotifications.inbox + unreadPostsCount;
    if (totalNotifications > 0) {
      profileBadge.style.display = 'flex';
      profileBadge.textContent = totalNotifications > 9 ? '9+' : totalNotifications.toString();
      
      if (isOwner() && unreadNotifications.inbox > 0) {
        profileBadge.style.background = 'linear-gradient(135deg, #ff3b3b, #ff6b6b)';
        profileBadge.style.animation = 'pulse 2s infinite';
      }
    } else {
      profileBadge.style.display = 'none';
    }
  }
}

function startPostsListener() {
  if (postsListener) postsListener();
  
  const lastSeenTime = getLastSeenPostsTime();
  let lastUpdate = 0;
  const updateInterval = 60000;
  
  postsListener = db.collection("posts")
    .where("createdAt", ">=", lastSeenTime)
    .where("status", "==", "active")
    .onSnapshot((snapshot) => {
      const now = Date.now();
      if (now - lastUpdate < updateInterval) return;
      
      lastUpdate = now;
      
      let newCount = 0;
      
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const postTime = change.doc.data().createdAt?.toDate?.();
          if (postTime && postTime > lastSeenTime) {
            newCount++;
          }
        }
      });
      
      if (newCount > 0) {
        unreadPostsCount = newCount;
        updateNavBadges();
      }
    }, (error) => {
    });
}

function stopAllListeners() {
  if (notificationsListener) {
    notificationsListener();
    notificationsListener = null;
  }
  if (postsListener) {
    postsListener();
    postsListener = null;
  }
}

function updateNavBadges() {
  const postsBadge = document.getElementById('posts-badge');
  if (postsBadge) {
    if (unreadPostsCount > 0) {
      postsBadge.style.display = 'flex';
      postsBadge.textContent = unreadPostsCount > 9 ? '9+' : unreadPostsCount.toString();
    } else {
      postsBadge.style.display = 'none';
    }
  }
  
  const inboxBadge = document.getElementById('inbox-badge');
  if (inboxBadge) {
    if (unreadNotifications.inbox > 0) {
      inboxBadge.style.display = 'flex';
      inboxBadge.textContent = unreadNotifications.inbox > 9 ? '9+' : unreadNotifications.inbox.toString();
    } else {
      inboxBadge.style.display = 'none';
    }
  }
  
  const profileBadge = document.getElementById('profile-notification-badge');
  if (profileBadge) {
    const totalProfileNotifications = unreadNotifications.inbox;
    if (totalProfileNotifications > 0) {
      profileBadge.style.display = 'flex';
      profileBadge.textContent = totalProfileNotifications > 9 ? '9+' : totalProfileNotifications.toString();
    } else {
      profileBadge.style.display = 'none';
    }
  }
}

async function markAllNotificationsAsRead() {
  if (!currentUser) return;
  
  const btn = document.getElementById('mark-all-read-btn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحديث...';
  
  try {
    let updatedCount = 0;
    
    if (isOwner()) {
      const unreadMessages = await db.collection('inbox')
        .where('status', '==', 'unread')
        .where('type', 'in', ['admin_report', 'support_request', 'support_reply'])
        .get();
      
      const batch = db.batch();
      unreadMessages.forEach(doc => {
        batch.update(doc.ref, { 
          status: 'read',
          readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        updatedCount++;
      });
      
      if (updatedCount > 0) {
        await batch.commit();
      }
    } else {
      const userMessages = await db.collection('inbox')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'unread')
        .get();
      
      const batch = db.batch();
      userMessages.forEach(doc => {
        batch.update(doc.ref, { 
          status: 'read',
          readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        updatedCount++;
      });
      
      if (updatedCount > 0) {
        await batch.commit();
      }
    }
    
    if (updatedCount > 0) {
      unreadNotifications.inbox = Math.max(0, unreadNotifications.inbox - updatedCount);
      
      updateAllBadges();
      
      if (document.getElementById('inbox-page').style.display === 'block') {
        await showInbox();
      }
      
      showNotification(`تم تحديد ${updatedCount} رسالة كمقروءة`);
    } else {
      showNotification('لا توجد رسائل غير مقروءة', 'info');
    }
    
  } catch (error) {
    showNotification('فشل تحديث حالة الرسائل', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function markPostsAsSeen() {
  updateLastSeenPostsTime();
}

function clearPostsBadge() {
  unreadPostsCount = 0;
  updateLastSeenPostsTime();
  updateAllBadges();
}

function clearInboxBadge() {
  unreadNotifications.inbox = 0;
  updateAllBadges();
}

function openForgotPasswordModal() {
  document.getElementById('forgot-password-modal').style.display = 'block';
}

function closeForgotPasswordModal() {
  document.getElementById('forgot-password-modal').style.display = 'none';
}

async function handleForgotPassword() {
  const email = document.getElementById('forgot-email').value.trim();
  const btn = document.getElementById('forgot-submit-btn');
  
  if (!email) {
    return showNotification('يرجى إدخال البريد الإلكتروني', 'error');
  }
  
  if (!validateEmail(email)) {
    return showNotification('صيغة البريد الإلكتروني غير صحيحة', 'error');
  }
  
  btn.disabled = true;
  btn.textContent = 'جاري الإرسال...';
  
  try {
    await auth.sendPasswordResetEmail(email);
    showNotification('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني');
    setTimeout(() => { closeForgotPasswordModal(); }, 3000);
  } catch (error) {
    let errorMessage = 'حدث خطأ أثناء إرسال رابط الاستعادة';
    switch (error.code) {
      case 'auth/user-not-found':
        errorMessage = 'البريد الإلكتروني غير مسجل في النظام';
        break;
      case 'auth/invalid-email':
        errorMessage = 'صيغة البريد الإلكتروني غير صحيحة';
        break;
      case 'auth/too-many-requests':
        errorMessage = 'محاولات كثيرة. حاول لاحقاً';
        break;
    }
    showNotification(errorMessage, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'إرسال رابط الاستعادة';
  }
}

function initializePullToRefresh() {
  let startY;
  let isAtTop = false;
  const pullIndicator = document.getElementById("pull-bubble");
  
  if (!pullIndicator) return;
  
  document.addEventListener('touchstart', e => {
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    isAtTop = (window.scrollY === 0);
    
    if (isAtTop) {
      startY = e.touches[0].pageY;
    }
  });
  
  document.addEventListener('touchmove', e => {
    if (!startY || !isAtTop) return;
    
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    const currentY = e.touches[0].pageY;
    const diff = currentY - startY;
    
    if (diff > 0 && window.scrollY === 0) {
      e.preventDefault();
      
      if (currentPage === 'main-page') {
        pullIndicator.style.display = 'block';
        pullIndicator.style.opacity = Math.min(1, diff / 100);
      }
    }
  });
  
  document.addEventListener('touchend', e => {
    if (!startY || !isAtTop) return;
    
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    const currentY = e.changedTouches[0].pageY;
    const diff = currentY - startY;
    
    if (diff > 100 && window.scrollY === 0) {
      if (currentPage === 'main-page') {
        pullIndicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...';
        
        setTimeout(() => {
          loadPostsFromFirestore().then(() => {
            pullIndicator.style.display = 'none';
            clearPostsBadge();
            showNotification("تم تحديث المنشورات");
          }).catch(error => {
            pullIndicator.style.display = 'none';
            showNotification("فشل التحديث", "error");
          });
        }, 1000);
      }
    } else {
      pullIndicator.style.display = 'none';
    }
    
    startY = null;
    isAtTop = false;
  });
  
  window.addEventListener('scroll', () => {
    if (window.scrollY > 10) {
      pullIndicator.style.display = 'none';
    }
  });
}

async function checkFirebaseConnection() {
  try {
    await db.collection('users').limit(1).get();
    return true;
    
  } catch (error) {
    return false;
  }
}

function initializeDOMElements() {
  window.postsContainer = document.getElementById("posts-container");
  window.companiesContainer = document.getElementById("companies-container");
  window.userPostsContainer = document.getElementById("user-posts-container");
  window.detailsContainer = document.getElementById("details-container");
  window.commentsList = document.getElementById("comments-list-page");
  window.inboxContainer = document.getElementById("inbox-container");
  window.createBtn = document.getElementById("create-btn");
  window.createBtnLabel = document.getElementById("create-btn-label");
  window.filterBox = document.getElementById("filter-container");
  window.pillPosts = document.getElementById("pill-posts");
  window.pillCompanies = document.getElementById("pill-companies");
}

function initializeStudyTimer() {
    if (studyTimer.isRunning && !studyTimer.isPaused && studyTimer.startTime) {
        document.getElementById('start-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').disabled = false;
        document.getElementById('stop-timer-btn').disabled = false;
        
        studyTimer.interval = setInterval(updateTimerDisplay, 1000);
        
        document.getElementById('start-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').disabled = false;
        document.getElementById('stop-timer-btn').disabled = false;
        document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-pause"></i> إيقاف مؤقت';
    }
    
    setTimeout(() => {
        loadStudySessions();
    }, 500);
}

function startStudyTimer() {
    document.getElementById('modal-session-name').value = '';
    document.getElementById('session-name-modal').style.display = 'block';
}

function closeSessionNameModal() {
    document.getElementById('session-name-modal').style.display = 'none';
}

function confirmSessionName() {
    const sessionName = document.getElementById('modal-session-name').value.trim();
    
    if (!sessionName) {
        showNotification('يرجى إدخال اسم الجلسة', 'error');
        return;
    }
    
    closeSessionNameModal();
    
    if (!studyTimer.isRunning) {
        studyTimer.startTime = Date.now();
        studyTimer.isRunning = true;
        studyTimer.isPaused = false;
        studyTimer.currentSessionName = sessionName;
        
        localStorage.setItem('studyTimerStartTime', studyTimer.startTime.toString());
        localStorage.setItem('studyTimerIsRunning', 'true');
        localStorage.setItem('studyTimerIsPaused', 'false');
        localStorage.setItem('currentSessionName', sessionName);
        
        document.getElementById('start-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').disabled = false;
        document.getElementById('stop-timer-btn').disabled = false;
        
        studyTimer.interval = setInterval(updateTimerDisplay, 1000);
        
        showNotification(`بدأت جلسة الدراسة: ${sessionName}`);
    }
}

function updateTimerDisplay() {
  if (studyTimer.isRunning && !studyTimer.isPaused) {
    let elapsedSeconds;
    
    if (studyTimer.startTime) {
      elapsedSeconds = Math.floor((Date.now() - studyTimer.startTime) / 1000);
    } else {
      elapsedSeconds = studyTimer.totalSeconds;
    }
    
    const hours = Math.floor(elapsedSeconds / 3600);
    const minutes = Math.floor((elapsedSeconds % 3600) / 60);
    const seconds = elapsedSeconds % 60;
    
    const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('study-timer-display').textContent = display;
  }
}

function pauseStudyTimer() {
  if (studyTimer.isRunning && !studyTimer.isPaused) {
    studyTimer.isPaused = true;
    studyTimer.totalSeconds = Math.floor((Date.now() - studyTimer.startTime) / 1000);
    
    localStorage.setItem('studyTimerTotalSeconds', studyTimer.totalSeconds.toString());
    localStorage.setItem('studyTimerIsPaused', 'true');
    
    clearInterval(studyTimer.interval);
    
    document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-play"></i> متابعة';
    showNotification('تم إيقاف العداد مؤقتاً', 'warning');
  } else if (studyTimer.isPaused) {
    studyTimer.startTime = Date.now() - (studyTimer.totalSeconds * 1000);
    studyTimer.isPaused = false;
    
    localStorage.setItem('studyTimerStartTime', studyTimer.startTime.toString());
    localStorage.setItem('studyTimerIsPaused', 'false');
    
    studyTimer.interval = setInterval(updateTimerDisplay, 1000);
    
    document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-pause"></i> إيقاف مؤقت';
    showNotification('استمرار الدراسة!');
  }
}

async function stopStudyTimer() {
    if (studyTimer.isRunning) {
        if (studyTimer.interval) {
            clearInterval(studyTimer.interval);
            studyTimer.interval = null;
        }
        
        let sessionSeconds = 0;
        if (studyTimer.startTime) {
            sessionSeconds = Math.floor((Date.now() - studyTimer.startTime) / 1000);
        }
        
        const sessionName = studyTimer.currentSessionName || 'جلسة دراسة';
        
        try {
            if (currentUser) {
                await db.collection('studySessions').add({
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    sessionName: sessionName,
                    duration: sessionSeconds,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            const sessions = JSON.parse(localStorage.getItem('studySessions') || '[]');
            sessions.unshift({
                sessionName: sessionName,
                duration: sessionSeconds,
                date: new Date().toISOString()
            });
            
            if (sessions.length > 5) {
                sessions.splice(5);
            }
            
            localStorage.setItem('studySessions', JSON.stringify(sessions));
            
        } catch (error) {
        }
        
        studyTimer.isRunning = false;
        studyTimer.isPaused = false;
        studyTimer.startTime = null;
        studyTimer.totalSeconds = 0;
        studyTimer.currentSessionName = '';
        
        localStorage.removeItem('studyTimerStartTime');
        localStorage.removeItem('studyTimerTotalSeconds');
        localStorage.removeItem('studyTimerIsRunning');
        localStorage.removeItem('studyTimerIsPaused');
        localStorage.removeItem('currentSessionName');
        
        document.getElementById('start-timer-btn').disabled = false;
        document.getElementById('pause-timer-btn').disabled = true;
        document.getElementById('stop-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-pause"></i> إيقاف مؤقت';
        
        document.getElementById('study-timer-display').textContent = '00:00:00';
        
        showNotification(`تم إنهاء جلسة الدراسة "${sessionName}"! الوقت: ${formatTime(sessionSeconds)}`);
        
        loadStudySessions();
    } else {
        showNotification('العداد غير نشط', 'warning');
    }
}

function formatTime(seconds) {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

async function loadStudySessions() {
    try {
        const sessionsContainer = document.getElementById('sessions-list');
        if (!sessionsContainer) return;
        
        let sessions = JSON.parse(localStorage.getItem('studySessions') || '[]');
        
        if (currentUser) {
            try {
                const userSessions = await db.collection('studySessions')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get();
                
                if (!userSessions.empty) {
                    sessions = userSessions.docs.map(doc => {
                        const data = doc.data();
                        return {
                            sessionName: data.sessionName,
                            duration: data.duration,
                            date: data.createdAt?.toDate?.().toISOString() || new Date().toISOString()
                        };
                    });
                    
                    localStorage.setItem('studySessions', JSON.stringify(sessions));
                }
            } catch (firebaseError) {
            }
        }
        
        if (sessions.length === 0) {
            sessionsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>لا توجد جلسات سابقة</p>
                </div>
            `;
            return;
        }
        
        sessionsContainer.innerHTML = sessions.map(session => {
            const date = new Date(session.date);
            const formattedDate = date.toLocaleDateString('ar-IQ', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const formattedTime = date.toLocaleTimeString('ar-IQ', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const durationFormatted = formatTime(session.duration);
            
            return `
                <div class="session-item">
                    <div class="session-info">
                        <div class="session-name">${escapeHTML(session.sessionName)}</div>
                        <div class="session-duration">المدة: ${durationFormatted}</div>
                    </div>
                    <div class="session-date">
                        <div>${formattedDate}</div>
                        <small style="color: #888; font-size: 11px;">${formattedTime}</small>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        const sessionsContainer = document.getElementById('sessions-list');
        if (sessionsContainer) {
            sessionsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>خطأ في تحميل الجلسات</p>
                </div>
            `;
        }
    }
}

let currentReportPostId = null;
let selectedReportReason = '';

function reportPost(postId) {
    if (!currentUser) {
        showNotification('يلزم تسجيل الدخول', 'warning');
        return;
    }
    
    currentReportPostId = postId;
    selectedReportReason = '';
    document.getElementById('report-custom-input').style.display = 'none';
    document.getElementById('report-custom-input').value = '';
    document.getElementById('report-submit-btn').disabled = true;
    document.getElementById('report-modal').style.display = 'block';
}

function selectReportReason(reason) {
    selectedReportReason = reason;
    document.getElementById('report-submit-btn').disabled = false;
    
    const customInput = document.getElementById('report-custom-input');
    if (reason === 'سبب آخر') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
    
    document.querySelectorAll('.report-reason-btn').forEach(btn => {
        btn.style.background = 'rgba(255, 255, 255, 0.15)';
        btn.style.border = '1px solid rgba(255, 255, 255, 0.3)';
    });
    
    event.target.style.background = 'rgba(255, 209, 102, 0.3)';
    event.target.style.border = '1px solid #ffd166';
}

function closeReportModal() {
    document.getElementById('report-modal').style.display = 'none';
    currentReportPostId = null;
    selectedReportReason = '';
}

async function submitReport() {
    if (!currentReportPostId || !selectedReportReason) return;
    
    const customReason = document.getElementById('report-custom-input').value.trim();
    const finalReason = selectedReportReason === 'سبب آخر' && customReason ? 
        `سبب آخر: ${customReason}` : selectedReportReason;
    
    if (!finalReason) {
        showNotification('يرجى اختيار سبب الإبلاغ', 'error');
        return;
    }
    
    const btn = document.getElementById('report-submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
    
    try {
        const post = posts.find(p => p.id === currentReportPostId);
        
        const ownerQuery = await db.collection('users')
            .where('email', '==', APP_OWNER_EMAIL)
            .limit(1)
            .get();
        
        if (ownerQuery.empty) return;
        
        const ownerDoc = ownerQuery.docs[0];
        const ownerUid = ownerDoc.id;
        
        await db.collection('inbox').add({
            userId: ownerUid,
            type: 'admin_report',
            postId: currentReportPostId,
            reporterUid: currentUser.uid,
            reporterName: currentUser.name || 'مستخدم',
            reporterShortUid: currentUser.shortUid || 'غير معروف',
            title: '🚨 بلاغ جديد',
            message: `👤 المبلغ: ${currentUser.name || 'مستخدم'}\n📝 السبب: ${finalReason}\n🆔 معرف المبلغ: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}`,
            status: 'unread',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
        if (!reportedPosts.includes(currentReportPostId)) {
            reportedPosts.push(currentReportPostId);
            localStorage.setItem('reportedPosts', JSON.stringify(reportedPosts));
        }
        
        showNotification('تم الإبلاغ عن المنشور وسيتم مراجعته');
        closeReportModal();
        
    } catch (e) {
        showNotification('تعذّر إرسال البلاغ', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال الإبلاغ';
    }
}

document.addEventListener('click', function(e) {
    if (e.target.id === 'report-modal') {
        closeReportModal();
    }
});

function openConfirmationModal(title, message, onConfirm) {
    document.getElementById('confirmation-title').textContent = title;
    document.getElementById('confirmation-message').textContent = message;
    document.getElementById('confirmation-confirm-btn').onclick = function() {
        onConfirm();
        closeConfirmationModal();
    };
    document.getElementById('confirmation-modal').style.display = 'block';
}

function closeConfirmationModal() {
    document.getElementById('confirmation-modal').style.display = 'none';
}

async function deletePostWithConfirmation(postId) {
    openConfirmationModal(
        'حذف المنشور',
        'هل أنت متأكد من حذف هذا المنشور؟',
        async function() {
            await deletePost(postId);
        }
    );
}

async function deleteCommentWithConfirmation(commentId, postId) {
    openConfirmationModal(
        'حذف التعليق',
        'هل أنت متأكد من حذف هذا التعليق؟',
        async function() {
            await deleteComment(commentId, postId);
        }
    );
}

async function banCommentUserWithConfirmation(userId, postId) {
    openConfirmationModal(
        'حظر المستخدم',
        'هل أنت متأكد من حظر هذا المستخدم من التعليق على منشوراتك؟',
        async function() {
            await banCommentUser(userId, postId);
        }
    );
}

function markSoldWithConfirmation(postId, isSold) {
    const action = isSold ? 'إلغاء البيع' : 'تم البيع';
    openConfirmationModal(
        action,
        `هل أنت متأكد من ${action} هذا المنشور؟`,
        async function() {
            await markSold(postId, isSold);
        }
    );
}

function showStudyTimerPage() {
  showPage("study-timer-page");
  
  // تحديث الشريط السفلي
  document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
    item.classList.remove("active");
    if (item.dataset.page === "study-timer") {
      item.classList.add("active");
    }
  });
}

function initializeApp() {
    try {
        initializeDOMElements();
        loadTheme();
        initializeImageUpload();
        initializePullToRefresh();
        initializePages();
        
        postsLimit = 10;
        postsOffset = 0;
        allPosts = [];
        displayPosts = [];
        
        setTimeout(() => {
            document.querySelectorAll(".owner-only").forEach(el => {
                if (isOwner()) {
                    el.style.display = "flex";
                }
            });
        }, 1000);
        
    } catch (error) {
        showNotification('حدث خطأ في تحميل التطبيق', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        try {
            initializeApp();
            
            setTimeout(() => {
                checkFirebaseConnection().then(connected => {
                    if (!connected) {
                    }
                });
            }, 2000);
        } catch (error) {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.innerHTML = 'خطأ في تحميل التطبيق<br><small>حدث خطأ غير متوقع</small>';
                loadingText.style.color = '#ff6b6b';
            }
        }
    }, 100);
});

async function calculateSupportRequests() {
  if (!isOwner()) return;
  
  try {
    const supportQuery = await db.collection('inbox')
      .where('type', 'in', ['support_request', 'admin_report'])
      .where('status', '==', 'unread')
      .get();
    
    const unreadSupportCount = supportQuery.size;
    
    const adminBadge = document.getElementById('admin-panel-badge');
    if (adminBadge) {
      if (unreadSupportCount > 0) {
        adminBadge.style.display = 'flex';
        adminBadge.textContent = unreadSupportCount > 9 ? '9+' : unreadSupportCount.toString();
        adminBadge.style.background = 'linear-gradient(135deg, #ff3b3b, #ff6b6b)';
        adminBadge.style.boxShadow = '0 2px 10px rgba(255, 59, 59, 0.5)';
        adminBadge.style.animation = 'pulse 1.5s infinite';
        
        if (window.lastSupportCount !== unreadSupportCount) {
          adminBadge.style.transform = 'scale(1.2)';
          setTimeout(() => {
            adminBadge.style.transform = 'scale(1)';
          }, 300);
        }
      } else {
        adminBadge.style.display = 'none';
      }
    }
    
    const supportBadge = document.getElementById('user-support-badge');
    if (supportBadge) {
      if (unreadSupportCount > 0) {
        supportBadge.style.display = 'flex';
        supportBadge.textContent = unreadSupportCount > 9 ? '9+' : unreadSupportCount.toString();
        supportBadge.style.background = 'linear-gradient(135deg, #ff6b6b, #ff8e6b)';
        supportBadge.style.boxShadow = '0 2px 10px rgba(255, 107, 107, 0.5)';
        supportBadge.style.animation = 'pulse 2s infinite';
      } else {
        supportBadge.style.display = 'none';
      }
    }
    
    const profileBadge = document.getElementById('profile-notification-badge');
    if (profileBadge) {
      const totalNotifications = (unreadNotifications.inbox || 0) + unreadSupportCount;
      if (totalNotifications > 0) {
        profileBadge.style.display = 'flex';
        profileBadge.textContent = totalNotifications > 9 ? '9+' : totalNotifications.toString();
        profileBadge.style.background = 'linear-gradient(135deg, #ff3b3b, #ff6b6b)';
        profileBadge.style.animation = 'pulse 2s infinite';
      }
    }
    
    window.lastSupportCount = unreadSupportCount;
    window.unreadSupportRequests = unreadSupportCount;
    
    if (unreadSupportCount > 0) {
      document.title = `(${unreadSupportCount}) ${document.title.replace(/^\(\d+\)\s*/, '')}`;
    } else {
      document.title = document.title.replace(/^\(\d+\)\s*/, '');
    }
    
    return unreadSupportCount;
    
  } catch (error) {
    try {
      const allMessages = await db.collection('inbox').get();
      let unreadSupportCount = 0;
      
      allMessages.forEach(doc => {
        const msg = doc.data();
        if ((msg.type === 'support_request' || msg.type === 'admin_report') && msg.status === 'unread') {
          unreadSupportCount++;
        }
      });
      
      updateAdminBadgesWithCount(unreadSupportCount);
      return unreadSupportCount;
      
    } catch (fallbackError) {
      return 0;
    }
  }
}

function updateAdminBadgesWithCount(count) {
  const adminBadge = document.getElementById('admin-panel-badge');
  if (adminBadge) {
    if (count > 0) {
      adminBadge.style.display = 'flex';
      adminBadge.textContent = count > 9 ? '9+' : count.toString();
    } else {
      adminBadge.style.display = 'none';
    }
  }
  
  const supportBadge = document.getElementById('user-support-badge');
  if (supportBadge) {
    if (count > 0) {
      supportBadge.style.display = 'flex';
      supportBadge.textContent = count > 9 ? '9+' : count.toString();
    } else {
      supportBadge.style.display = 'none';
    }
  }
}

async function markAllSupportAsRead() {
  if (!isOwner()) return;
  
  const btn = document.getElementById('mark-support-read-btn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحديث...';
  
  try {
    const unreadSupport = await db.collection('inbox')
      .where('status', '==', 'unread')
      .where('type', 'in', ['support_request', 'admin_report'])
      .get();
    
    const batch = db.batch();
    let updatedCount = 0;
    
    unreadSupport.forEach(doc => {
      batch.update(doc.ref, { 
        status: 'read',
        readAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      updatedCount++;
    });
    
    if (updatedCount > 0) {
      await batch.commit();
      
      unreadNotifications.inbox = Math.max(0, unreadNotifications.inbox - updatedCount);
      
      updateAllBadges();
      
      if (document.getElementById('user-support-page').style.display === 'block') {
        await loadUserSupportRequests();
      }
      
      showNotification(`تم تحديد ${updatedCount} طلب دعم كمقروء`);
    } else {
      showNotification('لا توجد رسائل غير مقروءة', 'info');
    }
    
  } catch (error) {
    showNotification('فشل تحديث حالة طلبات الدعم', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

</script>
</body>
</html>
